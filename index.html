<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prime Battle Academy 2.0</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
            
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ì½”ì¸ í‘œì‹œ ì˜ì—­ */
        .coin-display {
            position: absolute;
            top: 20px;
            right: 30px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 3px solid #ff8c00;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #744210;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .coin-icon {
            font-size: 1.5rem;
        }
        
        /* í›ˆë ¨ì¥ ë²„íŠ¼ */
        .shop-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(159, 122, 234, 0.4);
        }
        
        .shop-btn:hover {
            transform: translateY(-2px);
        }
        
        /* í›ˆë ¨ì¥ ëª¨ë‹¬ */
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .shop-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .shop-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }
        
        .shop-title {
            font-size: 2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .skill-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border: 3px solid #cbd5e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .skill-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .skill-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .skill-description {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .skill-cost {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 10px;
        }
        
        .buy-skill-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .buy-skill-btn:hover {
            transform: scale(1.05);
        }
        
        .buy-skill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .owned-badge {
            background: #48bb78;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .battle-arena {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
            position: relative;
        }
        
        .character-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid;
            position: relative;
        }
        
        .player-card {
            border-color: #48bb78;
        }
        
        .villain-card {
            border-color: #f56565;
        }
        
        .character-avatar {
            width: 360px;
            height: 360px;
            margin: 0 auto 20px;
            border-radius: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .hero-attack-gif, .devil-attack-gif {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 10;
        }
        
        .player-avatar {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .villain-avatar {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        
        .character-name {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-weight: bold;
            min-width: 60px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            background: #e2e8f0;
            border-radius: 10px;
            height: 25px;
            flex: 1;
            position: relative;
        }
        
        .stat-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .hp-fill { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .attack-fill { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .defense-fill { background: linear-gradient(90deg, #4299e1, #3182ce); }
        .mana-fill { background: linear-gradient(90deg, #9f7aea, #805ad5); }
        
        .battle-log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            height: 120px;
            overflow-y: auto;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .math-section {
            background: linear-gradient(145deg, #fef5e7, #fed7aa);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #f6ad55;
        }
        
        .math-problem {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #744210;
        }
        
        .answer-section {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .answer-input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: 3px solid #f6ad55;
            border-radius: 10px;
            text-align: center;
            width: 120px;
            font-weight: bold;
        }
        
        .submit-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ìŠ¤í‚¬ ë²„íŠ¼ ì˜ì—­ */
        .skill-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .skill-use-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .skill-use-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }
        
        .skill-use-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .skill-cost-badge {
            font-size: 0.8rem;
            display: block;
            margin-top: 3px;
        }
        
        .upgrade-section {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .upgrade-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        
        .upgrade-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
        }
        
        .next-level-btn {
            padding: 15px 35px;
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .next-level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(159, 122, 234, 0.4);
        }
        
        .victory-section, .game-over-section {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(145deg, #c6f6d5, #9ae6b4);
            border-radius: 15px;
            border: 3px solid #48bb78;
        }
        
        .game-over-section {
            background: linear-gradient(145deg, #fed7d7, #fc8181);
            border-color: #f56565;
        }
        
        .section-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .restart-btn {
            padding: 15px 35px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        
        .records-section {
            background: linear-gradient(145deg, #e6fffa, #b2f5ea);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 3px solid #38b2ac;
        }
        
        .records-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #234e52;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .record-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .record-label {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .record-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
        }
    </style>
 </head>
 <body>
  <audio id="hero-hit" src="https://docs.google.com/uc?export=download&id=1nR9a7y9tSpyq2pfaWy8qvmFqVIqINAjp"></audio>
  <audio id="boss-hit" src="https://docs.google.com/uc?export=download&id=1SYrF0EqHxe2dkdwS2d4KhEMp1cDbL_wh"></audio>
  <audio id="upgrade-sound" src="https://docs.google.com/uc?export=download&id=1HjsOdPDvhK4TWMi0ZW0mLrj7msCcjYOp"></audio>
  <audio id="healing-magic" src="https://docs.google.com/uc?export=download&id=1JLQXBQKxXD7lWGkPEYP-d9MYNDaMvH7F"></audio>
  <audio id="game-over" src="https://docs.google.com/uc?export=download&id=1vPKNIAYGhHuFZJt0GSTDGQV4SoIvg0Eq"></audio>
  
  <div class="game-container">
    <!-- í›ˆë ¨ì¥ ë²„íŠ¼ -->
    <button class="shop-btn" onclick="openShop()">ğŸª í›ˆë ¨ì¥</button>
    
    <!-- ì½”ì¸ í‘œì‹œ -->
    <div class="coin-display">
        <span class="coin-icon">ğŸª™</span>
        <span id="coinAmount">0</span>
    </div>
    
    <h1 class="game-title" id="dynamicGameTitle">ğŸ® Prime Battle Academy ğŸ®</h1>
    
    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="records-section">
        <div class="records-title">ğŸ“Š í˜„ì¬ í”Œë ˆì´ ê¸°ë¡</div>
        <div class="records-grid">
            <div class="record-item">
                <div class="record-label">ë„ë‹¬ ë ˆë²¨</div>
                <div class="record-value" id="currentLevel">1</div>
            </div>
            <div class="record-item">
                <div class="record-label">í•´ê²°í•œ ë¬¸ì œ</div>
                <div class="record-value" id="currentProblems">0</div>
            </div>
            <div class="record-item">
                <div class="record-label">ì´ ë°ë¯¸ì§€</div>
                <div class="record-value" id="currentDamage">0</div>
            </div>
            <div class="record-item">
                <div class="record-label">í”Œë ˆì´ ì‹œê°„</div>
                <div class="record-value" id="currentTime">0:00</div>
            </div>
        </div>
    </div>
    
    <div class="records-section" style="background: linear-gradient(145deg, #fef5e7, #feebc8); border-color: #ed8936;">
        <div class="records-title">ğŸ† ìµœê³  ê¸°ë¡</div>
        <div class="records-grid">
            <div class="record-item">
                <div class="record-label">ìµœê³  ë ˆë²¨</div>
                <div class="record-value" id="bestLevel">1</div>
            </div>
            <div class="record-item">
                <div class="record-label">ìµœë‹¤ ë¬¸ì œ</div>
                <div class="record-value" id="bestProblems">0</div>
            </div>
            <div class="record-item">
                <div class="record-label">ìµœëŒ€ ë°ë¯¸ì§€</div>
                <div class="record-value" id="bestDamage">0</div>
            </div>
            <div class="record-item">
                <div class="record-label">ìµœì¥ ì‹œê°„</div>
                <div class="record-value" id="bestTime">0:00</div>
            </div>
        </div>
    </div>
    
    <div class="battle-arena">
        <div class="level-indicator" id="levelIndicator">ë ˆë²¨ 1</div>
        
        <!-- í”Œë ˆì´ì–´ ì¹´ë“œ -->
        <div class="character-card player-card">
            <div class="character-avatar player-avatar">
                <img id="heroImage" src="https://i.ibb.co/BNGByb7/image.png" style="width: 100%; height: 100%; object-fit: cover;">
                <img id="heroAttackGif" class="hero-attack-gif" src="https://i.ibb.co/7Yb7VhG/image.gif">
            </div>
            <div class="character-name" id="playerName">âš”ï¸ ìš©ì‚¬</div>
            <div class="stats">
                <div class="stat-bar">
                    <span class="stat-label">ì²´ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill hp-fill" id="playerHpBar">100/100</div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">ê³µê²©ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill attack-fill" id="playerAttackBar" style="width: 100%;">15</div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">ë°©ì–´ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill defense-fill" id="playerDefenseBar" style="width: 100%;">10</div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">ë§ˆë‚˜</span>
                    <div class="stat-value">
                        <div class="stat-fill mana-fill" id="playerManaBar">0/20</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ë¹ŒëŸ° ì¹´ë“œ -->
        <div class="character-card villain-card">
            <div class="character-avatar villain-avatar">
                <img id="devilImage" src="https://i.ibb.co/FhwMhzN/2.png" style="width: 100%; height: 100%; object-fit: cover;">
                <img id="devilAttackGif" class="devil-attack-gif" src="https://i.ibb.co/4YcZQN2/devil-attack.gif">
            </div>
            <div class="character-name" id="villainName">ğŸ‘¿ ìˆ˜í•™ ë§ˆì™•</div>
            <div class="stats">
                <div class="stat-bar">
                    <span class="stat-label">ì²´ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill hp-fill" id="villainHpBar">80/80</div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">ê³µê²©ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill attack-fill" id="villainAttackBar" style="width: 100%;">12</div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">ë°©ì–´ë ¥</span>
                    <div class="stat-value">
                        <div class="stat-fill defense-fill" id="villainDefenseBar" style="width: 100%;">8</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="battle-log" id="battleLog">ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!<br></div>
    
    <div class="math-section">
        <div class="math-problem" id="mathProblem">2 Ã— 3 = ?</div>
        <div class="answer-section">
            <input type="number" id="answerInput" class="answer-input" placeholder="ë‹µ">
            <button id="submitBtn" class="submit-btn" onclick="checkAnswer()">ê³µê²©!</button>
        </div>
        
        <!-- ìŠ¤í‚¬ ë²„íŠ¼ ì˜ì—­ -->
        <div class="skill-buttons" id="skillButtons">
            <button id="recoveryBtn" class="skill-use-btn" onclick="useRecovery()" disabled>
                ğŸ’š ì²´ë ¥ íšŒë³µ
                <span class="skill-cost-badge">ë§ˆë‚˜ 20</span>
            </button>
        </div>
        
        <div class="upgrade-section" id="upgradeSection">
            <div class="section-title">âš¡ ê°•í™”í•˜ê¸°</div>
            <div class="upgrade-container">
                <button class="upgrade-btn" onclick="upgradeAttack()">ğŸ—¡ï¸ ê³µê²©ë ¥ +5</button>
                <button class="upgrade-btn" onclick="upgradeDefense()">ğŸ›¡ï¸ ë°©ì–´ë ¥ +3</button>
                <button class="upgrade-btn" onclick="upgradeMaxHp()">â¤ï¸ ìµœëŒ€ì²´ë ¥ +20</button>
            </div>
        </div>
        
        <div class="victory-section" id="victorySection">
            <div class="section-title">ğŸ‰ ìŠ¹ë¦¬! ğŸ‰</div>
            <p>ë ˆë²¨ì„ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</p>
            <button class="next-level-btn" onclick="nextLevel()">ë‹¤ìŒ ë ˆë²¨ â†’</button>
        </div>
        
        <div class="game-over-section" id="gameOverSection">
            <div class="section-title">ğŸ’€ ê²Œì„ ì˜¤ë²„ ğŸ’€</div>
            <p>ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!</p>
            <button class="restart-btn" onclick="restartGame()">ì¬ì‹œì‘</button>
        </div>
    </div>
  </div>
  
  <!-- í›ˆë ¨ì¥ ëª¨ë‹¬ -->
  <div class="shop-modal" id="shopModal">
    <div class="shop-content">
        <button class="shop-close" onclick="closeShop()">Ã—</button>
        <h2 class="shop-title">ğŸª í›ˆë ¨ì¥ - ìŠ¤í‚¬ ìƒì </h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <span style="font-size: 1.3rem; font-weight: bold; color: #ff8c00;">
                ë³´ìœ  ì½”ì¸: <span id="shopCoinAmount">0</span> ğŸª™
            </span>
        </div>
        
        <div class="skill-grid" id="skillShop"></div>
    </div>
  </div>
  
  <script>
        const defaultConfig = {
            game_title: "Prime Battle Academy",
            player_name: "âš”ï¸ ìš©ì‚¬",
            villain_name: "ğŸ‘¿ ìˆ˜í•™ ë§ˆì™•",
            hero_image_url: "https://i.ibb.co/BNGByb7/image.png",
            devil_image_url: "https://i.ibb.co/FhwMhzN/2.png",
            hero_attack_gif_url: "https://i.ibb.co/7Yb7VhG/image.gif",
            devil_attack_gif_url: "https://i.ibb.co/4YcZQN2/devil-attack.gif"
        };

        if (window.elementSdk && window.elementSdk.config) {
            const config = window.elementSdk.config;
            if (config.game_title) {
                document.getElementById('dynamicGameTitle').textContent = config.game_title;
            }
            if (config.player_name) {
                document.getElementById('playerName').textContent = config.player_name;
            }
            if (config.villain_name) {
                document.getElementById('villainName').textContent = `Lv1 ${config.villain_name}`;
            }
            if (config.hero_image_url) {
                document.getElementById('heroImage').src = config.hero_image_url;
            }
            if (config.devil_image_url) {
                document.getElementById('devilImage').src = config.devil_image_url;
            }
            if (config.hero_attack_gif_url) {
                document.getElementById('heroAttackGif').src = config.hero_attack_gif_url;
            }
            if (config.devil_attack_gif_url) {
                document.getElementById('devilAttackGif').src = config.devil_attack_gif_url;
            }
        }

        // ìŠ¤í‚¬ ì •ì˜
        const SKILLS = {
            fireball: {
                id: 'fireball',
                name: 'ğŸ”¥ íŒŒì´ì–´ë³¼',
                description: 'ê°•ë ¥í•œ í™”ì—¼êµ¬ë¥¼ ë°œì‚¬í•©ë‹ˆë‹¤',
                icon: 'ğŸ”¥',
                cost: 50,
                useCost: { type: 'mana', amount: 15 },
                effect: { type: 'damage', value: 40 }
            },
            lightning: {
                id: 'lightning',
                name: 'âš¡ ë²ˆê°œ',
                description: 'ë¹ ë¥¸ ë²ˆê°œ ê³µê²©',
                icon: 'âš¡',
                cost: 70,
                useCost: { type: 'mana', amount: 18 },
                effect: { type: 'damage', value: 50 }
            },
            meteor: {
                id: 'meteor',
                name: 'â˜„ï¸ ë©”í…Œì˜¤',
                description: 'ê±°ëŒ€í•œ ìš´ì„ì„ ë–¨ì–´ëœ¨ë¦½ë‹ˆë‹¤',
                icon: 'â˜„ï¸',
                cost: 100,
                useCost: { type: 'mana', amount: 20 },
                effect: { type: 'damage', value: 70 }
            },
            berserk: {
                id: 'berserk',
                name: 'ğŸ’¥ ê´‘í­í™”',
                description: 'ê³µê²©ë ¥ì´ ì¼ì‹œì ìœ¼ë¡œ ì¦ê°€',
                icon: 'ğŸ’¥',
                cost: 80,
                useCost: { type: 'hp', amount: 15 },
                effect: { type: 'damage', value: 45 }
            },
            ultimate: {
                id: 'ultimate',
                name: 'ğŸŒŸ ê¶ê·¹ê¸°',
                description: 'ìµœê°•ì˜ ê³µê²©!',
                icon: 'ğŸŒŸ',
                cost: 150,
                useCost: { type: 'hp', amount: 20, mana: 20 },
                effect: { type: 'damage', value: 100 }
            }
        };

        // ê²Œì„ ìƒíƒœ
        let gameState = {
            level: 1,
            coins: 0,
            ownedSkills: [],
            player: {
                hp: 100,
                maxHp: 100,
                attack: 15,
                defense: 10,
                mana: 0,
                maxMana: 20
            },
            villain: {
                hp: 80,
                maxHp: 80,
                attack: 12,
                defense: 8
            },
            currentProblem: {
                num1: 2,
                num2: 3,
                answer: 6
            },
            battleInterval: null,
            manaInterval: null,
            gameActive: true,
            currentStats: {
                problemsSolved: 0,
                totalDamage: 0,
                startTime: Date.now()
            },
            bestRecords: {
                maxLevel: 1,
                maxProblems: 0,
                maxDamage: 0,
                maxTime: 0
            }
        };

        let allRecords = [];
        let gameLoaded = false;

        // ë°ì´í„° SDK ì´ˆê¸°í™”
        if (window.dataSdk) {
            window.dataSdk.getAll().then(records => {
                allRecords = records || [];
                
                // ìµœê³  ê¸°ë¡ ë¡œë“œ
                const bestRecords = allRecords.filter(r => r.record_type === 'best_records');
                if (bestRecords.length > 0) {
                    const latest = bestRecords.reduce((a, b) => 
                        new Date(a.timestamp) > new Date(b.timestamp) ? a : b
                    );
                    gameState.bestRecords = {
                        maxLevel: latest.max_level || 1,
                        maxProblems: latest.max_problems || 0,
                        maxDamage: latest.max_damage || 0,
                        maxTime: latest.max_time || 0
                    };
                }
                
                // ê²Œì„ ì§„í–‰ ìƒí™© ë¡œë“œ
                const progressRecords = allRecords.filter(r => r.record_type === 'game_progress');
                if (progressRecords.length > 0) {
                    const latest = progressRecords.reduce((a, b) => 
                        new Date(a.timestamp) > new Date(b.timestamp) ? a : b
                    );
                    
                    gameState.level = latest.level || 1;
                    gameState.coins = latest.coins || 0;
                    gameState.ownedSkills = latest.owned_skills || [];
                    gameState.player = latest.player_stats || gameState.player;
                    
                    const levelMultiplier = 1 + (gameState.level - 1) * 0.3;
                    gameState.villain = {
                        hp: Math.floor(80 * levelMultiplier),
                        maxHp: Math.floor(80 * levelMultiplier),
                        attack: Math.floor(12 * levelMultiplier),
                        defense: Math.floor(8 * levelMultiplier)
                    };
                    
                    gameState.currentStats = latest.current_stats || gameState.currentStats;
                    gameLoaded = true;
                    
                    addBattleLog('ì´ì „ ê²Œì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                }
                
                updateDisplay();
                updateRecordsDisplay();
                renderSkillButtons();
            });
        }

        // ì†Œìˆ˜ ìƒì„±
        function generatePrime(min, max) {
            const primes = [];
            for (let num = min; num <= max; num++) {
                let isPrime = num > 1;
                for (let i = 2; i <= Math.sqrt(num); i++) {
                    if (num % i === 0) {
                        isPrime = false;
                        break;
                    }
                }
                if (isPrime) primes.push(num);
            }
            return primes[Math.floor(Math.random() * primes.length)];
        }

        // ë¬¸ì œ ìƒì„±
        function generateProblem() {
            const num1 = generatePrime(2, 20);
            const num2 = generatePrime(2, 20);
            gameState.currentProblem = {
                num1: num1,
                num2: num2,
                answer: num1 * num2
            };
            document.getElementById('mathProblem').textContent = `${num1} Ã— ${num2} = ?`;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
        }

        // ì •ë‹µ ì²´í¬
        function checkAnswer() {
            if (!gameState.gameActive) return;
            
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            
            if (userAnswer === gameState.currentProblem.answer) {
                const damage = Math.max(1, gameState.player.attack - gameState.villain.defense);
                gameState.villain.hp = Math.max(0, gameState.villain.hp - damage);
                
                // ì½”ì¸ íšë“
                const coinsEarned = 5;
                gameState.coins += coinsEarned;
                
                gameState.currentStats.problemsSolved++;
                gameState.currentStats.totalDamage += damage;
                
                addBattleLog(`âœ… ì •ë‹µ! ${damage} ë°ë¯¸ì§€! (+${coinsEarned} ğŸª™)`);
                playHeroAttackSound();
                triggerHitEffect('heroAttackGif');
                
                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
                
                generateProblem();
            } else {
                addBattleLog(`âŒ ì˜¤ë‹µ! ì •ë‹µì€ ${gameState.currentProblem.answer}ì…ë‹ˆë‹¤.`);
                generateProblem();
            }
            
            updateDisplay();
            saveGameProgress();
        }

        // ì²´ë ¥ íšŒë³µ
        function useRecovery() {
            if (gameState.player.mana >= 20) {
                const healAmount = 30;
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                gameState.player.mana -= 20;
                addBattleLog(`ğŸ’š ì²´ë ¥ì„ ${healAmount} íšŒë³µí–ˆìŠµë‹ˆë‹¤!`);
                playhealingSound();
                updateDisplay();
                saveGameProgress();
            }
        }

        // ìŠ¤í‚¬ ì‚¬ìš©
        function useSkill(skillId) {
            if (!gameState.gameActive) return;
            
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            // ë¹„ìš© ì²´í¬
            if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                addBattleLog(`âŒ ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                addBattleLog(`âŒ ì²´ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.mana && gameState.player.mana < skill.useCost.mana) {
                addBattleLog(`âŒ ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.mana})`);
                return;
            }
            if (skill.useCost.hp && gameState.player.hp <= skill.useCost.hp) {
                addBattleLog(`âŒ ì²´ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.hp})`);
                return;
            }
            
            // ë¹„ìš© ì°¨ê°
            if (skill.useCost.type === 'mana') {
                gameState.player.mana -= skill.useCost.amount;
            } else if (skill.useCost.type === 'hp') {
                gameState.player.hp -= skill.useCost.amount;
            }
            if (skill.useCost.mana) {
                gameState.player.mana -= skill.useCost.mana;
            }
            if (skill.useCost.hp) {
                gameState.player.hp -= skill.useCost.hp;
            }
            
            // íš¨ê³¼ ì ìš©
            if (skill.effect.type === 'damage') {
                const damage = skill.effect.value;
                gameState.villain.hp = Math.max(0, gameState.villain.hp - damage);
                gameState.currentStats.totalDamage += damage;
                addBattleLog(`${skill.icon} ${skill.name} ì‚¬ìš©! ${damage} ë°ë¯¸ì§€!`);
                playHeroAttackSound();
                triggerHitEffect('heroAttackGif');
                
                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
            }
            
            updateDisplay();
            saveGameProgress();
        }

        // ì „íˆ¬ ì‹œì‘
        function startBattle() {
            gameState.battleInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                const damage = Math.max(1, gameState.villain.attack - gameState.player.defense);
                gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                
                addBattleLog(`ğŸ‘¿ ë§ˆì™•ì˜ ê³µê²©! ${damage} ë°ë¯¸ì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤!`);
                playBossAttackSound();
                triggerHitEffect('devilAttackGif');
                
                if (gameState.player.hp <= 0) {
                    gameOver();
                }
                
                updateDisplay();
            }, 3000);
        }

        // ë§ˆë‚˜ ì¬ìƒ
        function startManaRegeneration() {
            gameState.manaInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                if (gameState.player.mana < gameState.player.maxMana) {
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + 1);
                    updateDisplay();
                }
            }, 2000);
        }

        // ìŠ¤íƒ¯ ì—…ê·¸ë ˆì´ë“œ
        function upgradeAttack() {
            gameState.player.attack += 5;
            addBattleLog('âš”ï¸ ê³µê²©ë ¥ì´ 5 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!');
            playupgradeSound();
            document.getElementById('upgradeSection').style.display = 'none';
            updateDisplay();
            saveGameProgress();
        }

        function upgradeDefense() {
            gameState.player.defense += 3;
            addBattleLog('ğŸ›¡ï¸ ë°©ì–´ë ¥ì´ 3 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!');
            playupgradeSound();
            document.getElementById('upgradeSection').style.display = 'none';
            updateDisplay();
            saveGameProgress();
        }

        function upgradeMaxHp() {
            gameState.player.maxHp += 20;
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + 20);
            addBattleLog('â¤ï¸ ìµœëŒ€ ì²´ë ¥ì´ 20 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!');
            playupgradeSound();
            document.getElementById('upgradeSection').style.display = 'none';
            updateDisplay();
            saveGameProgress();
        }

        // ê¸°ë¡ ì—…ë°ì´íŠ¸
        function updateBestRecords() {
            let updated = false;
            
            if (gameState.level > gameState.bestRecords.maxLevel) {
                gameState.bestRecords.maxLevel = gameState.level;
                updated = true;
            }
            if (gameState.currentStats.problemsSolved > gameState.bestRecords.maxProblems) {
                gameState.bestRecords.maxProblems = gameState.currentStats.problemsSolved;
                updated = true;
            }
            if (gameState.currentStats.totalDamage > gameState.bestRecords.maxDamage) {
                gameState.bestRecords.maxDamage = gameState.currentStats.totalDamage;
                updated = true;
            }
            
            const playTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            if (playTime > gameState.bestRecords.maxTime) {
                gameState.bestRecords.maxTime = playTime;
                updated = true;
            }
            
            if (updated && window.dataSdk) {
                window.dataSdk.create({
                    record_type: 'best_records',
                    max_level: gameState.bestRecords.maxLevel,
                    max_problems: gameState.bestRecords.maxProblems,
                    max_damage: gameState.bestRecords.maxDamage,
                    max_time: gameState.bestRecords.maxTime,
                    timestamp: new Date().toISOString()
                });
            }
        }

        function updateRecordsDisplay() {
            document.getElementById('currentLevel').textContent = gameState.level;
            document.getElementById('currentProblems').textContent = gameState.currentStats.problemsSolved;
            document.getElementById('currentDamage').textContent = gameState.currentStats.totalDamage;
            
            const currentPlayTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            const currentMinutes = Math.floor(currentPlayTime / 60);
            const currentSeconds = currentPlayTime % 60;
            document.getElementById('currentTime').textContent = 
                `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
            
            document.getElementById('bestLevel').textContent = gameState.bestRecords.maxLevel;
            document.getElementById('bestProblems').textContent = gameState.bestRecords.maxProblems;
            document.getElementById('bestDamage').textContent = gameState.bestRecords.maxDamage;
            
            const bestMinutes = Math.floor(gameState.bestRecords.maxTime / 60);
            const bestSeconds = gameState.bestRecords.maxTime % 60;
            document.getElementById('bestTime').textContent = 
                `${bestMinutes}:${bestSeconds.toString().padStart(2, '0')}`;
        }

        function saveGameSession() {
            if (window.dataSdk) {
                window.dataSdk.create({
                    record_type: 'game_session',
                    level_reached: gameState.level,
                    problems_solved: gameState.currentStats.problemsSolved,
                    total_damage: gameState.currentStats.totalDamage,
                    play_time: Math.floor((Date.now() - gameState.currentStats.startTime) / 1000),
                    timestamp: new Date().toISOString()
                });
            }
        }

        function saveGameProgress() {
            if (window.dataSdk) {
                const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
                progressRecords.forEach(async (record) => {
                    await window.dataSdk.delete(record);
                });
                
                window.dataSdk.create({
                    record_type: 'game_progress',
                    level: gameState.level,
                    coins: gameState.coins,
                    owned_skills: gameState.ownedSkills,
                    player_stats: gameState.player,
                    current_stats: gameState.currentStats,
                    timestamp: new Date().toISOString()
                }).then(record => {
                    allRecords.push(record);
                });
            }
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            // ì½”ì¸ í‘œì‹œ
            document.getElementById('coinAmount').textContent = gameState.coins;
            document.getElementById('shopCoinAmount').textContent = gameState.coins;
            
            // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('playerHpBar').style.width = `${playerHpPercent}%`;
            document.getElementById('playerHpBar').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('playerAttackBar').textContent = gameState.player.attack;
            document.getElementById('playerDefenseBar').textContent = gameState.player.defense;
            
            const playerManaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            document.getElementById('playerManaBar').style.width = `${playerManaPercent}%`;
            document.getElementById('playerManaBar').textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            
            // íšŒë³µ ë²„íŠ¼ ìƒíƒœ
            const recoveryBtn = document.getElementById('recoveryBtn');
            if (gameState.player.mana >= 20) {
                recoveryBtn.disabled = false;
                recoveryBtn.style.opacity = '1';
            } else {
                recoveryBtn.disabled = true;
                recoveryBtn.style.opacity = '0.6';
            }
            
            // ìŠ¤í‚¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            gameState.ownedSkills.forEach(skillId => {
                const btn = document.getElementById(`skill-${skillId}`);
                if (btn) {
                    const skill = SKILLS[skillId];
                    let canUse = true;
                    
                    if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                        canUse = false;
                    }
                    if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                        canUse = false;
                    }
                    if (skill.useCost.mana && gameState.player.mana < skill.useCost.mana) {
                        canUse = false;
                    }
                    if (skill.useCost.hp && gameState.player.hp <= skill.useCost.hp) {
                        canUse = false;
                    }
                    
                    btn.disabled = !canUse;
                    btn.style.opacity = canUse ? '1' : '0.6';
                }
            });
            
            // ë¹ŒëŸ° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const villainHpPercent = (gameState.villain.hp / gameState.villain.maxHp) * 100;
            document.getElementById('villainHpBar').style.width = `${villainHpPercent}%`;
            document.getElementById('villainHpBar').textContent = `${gameState.villain.hp}/${gameState.villain.maxHp}`;
            document.getElementById('villainAttackBar').textContent = gameState.villain.attack;
            document.getElementById('villainDefenseBar').textContent = gameState.villain.defense;
            
            // ë ˆë²¨ í‘œì‹œ
            document.getElementById('levelIndicator').textContent = `ë ˆë²¨ ${gameState.level}`;

            let baseVillainName = defaultConfig.villain_name;
            if (window.elementSdk && window.elementSdk.config && window.elementSdk.config.villain_name) {
                baseVillainName = window.elementSdk.config.villain_name;
            }
            document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
        }

        // ì „íˆ¬ ë¡œê·¸ ì¶”ê°€
        function addBattleLog(message) {
            const log = document.getElementById('battleLog');
            log.innerHTML += message + '<br>';
            log.scrollTop = log.scrollHeight;
        }

        // ìŠ¹ë¦¬
        function victory() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('answerInput').style.opacity = '0.6';
            document.getElementById('submitBtn').style.opacity = '0.6';
            
            updateBestRecords();
            saveGameSession();
            saveGameProgress();
            
            document.getElementById('victorySection').style.display = 'block';
            addBattleLog(`ğŸ‰ ë ˆë²¨ ${gameState.level} í´ë¦¬ì–´! ğŸ‰`);
            addBattleLog('ë‹¤ìŒ ë ˆë²¨ë¡œ ì§„í–‰í•˜ì„¸ìš”!');
        }

        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            updateBestRecords();
            saveGameSession();
            
            const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
            progressRecords.forEach(async (record) => {
                if (window.dataSdk) {
                    await window.dataSdk.delete(record);
                }
            });
            
            document.getElementById('gameOverSection').style.display = 'block';
            addBattleLog('ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ğŸ’€');
            playgameoverSound();
        }

        // ë‹¤ìŒ ë ˆë²¨
        function nextLevel() {
            gameState.level++;
            gameState.gameActive = true;
            
            const levelMultiplier = 1 + (gameState.level - 1) * 0.3;
            gameState.villain = {
                hp: Math.floor(80 * levelMultiplier),
                maxHp: Math.floor(80 * levelMultiplier),
                attack: Math.floor(12 * levelMultiplier),
                defense: Math.floor(8 * levelMultiplier)
            };
            
            document.getElementById('victorySection').style.display = 'none';
            document.getElementById('gameOverSection').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';
            
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            addBattleLog(`ë ˆë²¨ ${gameState.level} ì‹œì‘! ë” ê°•í•œ ${document.getElementById('villainName').textContent}ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
            
            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            gameState = {
                level: 1,
                coins: 0,
                ownedSkills: [],
                player: { hp: 100, maxHp: 100, attack: 15, defense: 10, mana: 0, maxMana: 20 },
                villain: { hp: 80, maxHp: 80, attack: 12, defense: 8 },
                currentProblem: { num1: 2, num2: 3, answer: 6 },
                battleInterval: null,
                manaInterval: null,
                gameActive: true,
                currentStats: {
                    problemsSolved: 0,
                    totalDamage: 0,
                    startTime: Date.now()
                },
                bestRecords: gameState.bestRecords
            };
            
            document.getElementById('gameOverSection').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';
            
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            document.getElementById('battleLog').innerHTML = 'ê²Œì„ì´ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!<br>';
            
            renderSkillButtons();
            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // í›ˆë ¨ì¥ ì—´ê¸°/ë‹«ê¸°
        function openShop() {
            document.getElementById('shopModal').style.display = 'flex';
            renderShop();
        }

        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
        }

        // ìƒì  ë Œë”ë§
        function renderShop() {
            const shopElement = document.getElementById('skillShop');
            shopElement.innerHTML = '';
            
            Object.values(SKILLS).forEach(skill => {
                const owned = gameState.ownedSkills.includes(skill.id);
                const canBuy = gameState.coins >= skill.cost && !owned;
                
                const card = document.createElement('div');
                card.className = 'skill-card';
                card.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-description">${skill.description}</div>
                    <div class="skill-cost">ğŸ’° ${skill.cost} ì½”ì¸</div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                        ì‚¬ìš© ë¹„ìš©: ${skill.useCost.type === 'mana' ? `ë§ˆë‚˜ ${skill.useCost.amount}` : ''}
                        ${skill.useCost.type === 'hp' ? `ì²´ë ¥ ${skill.useCost.amount}` : ''}
                        ${skill.useCost.mana ? `ë§ˆë‚˜ ${skill.useCost.mana}` : ''}
                        ${skill.useCost.hp ? ` ì²´ë ¥ ${skill.useCost.hp}` : ''}
                    </div>
                    ${owned ? 
                        '<div class="owned-badge">âœ… ë³´ìœ ì¤‘</div>' :
                        `<button class="buy-skill-btn" onclick="buySkill('${skill.id}')" ${!canBuy ? 'disabled' : ''}>
                            êµ¬ë§¤í•˜ê¸°
                        </button>`
                    }
                `;
                shopElement.appendChild(card);
            });
        }

        // ìŠ¤í‚¬ êµ¬ë§¤
        function buySkill(skillId) {
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            if (gameState.coins < skill.cost) {
                addBattleLog('âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }
            
            if (gameState.ownedSkills.includes(skillId)) {
                addBattleLog('âŒ ì´ë¯¸ ë³´ìœ í•œ ìŠ¤í‚¬ì…ë‹ˆë‹¤!');
                return;
            }
            
            gameState.coins -= skill.cost;
            gameState.ownedSkills.push(skillId);
            
            addBattleLog(`âœ¨ ${skill.name} ìŠ¤í‚¬ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`);
            playupgradeSound();
            
            renderShop();
            renderSkillButtons();
            updateDisplay();
            saveGameProgress();
        }

        // ìŠ¤í‚¬ ë²„íŠ¼ ë Œë”ë§
        function renderSkillButtons() {
            const container = document.getElementById('skillButtons');
            
            // íšŒë³µ ë²„íŠ¼ ì œì™¸í•˜ê³  ëª¨ë“  ë²„íŠ¼ ì œê±°
            const recoveryBtn = document.getElementById('recoveryBtn');
            container.innerHTML = '';
            container.appendChild(recoveryBtn);
            
            // ë³´ìœ í•œ ìŠ¤í‚¬ ë²„íŠ¼ ì¶”ê°€
            gameState.ownedSkills.forEach(skillId => {
                const skill = SKILLS[skillId];
                if (!skill) return;
                
                const btn = document.createElement('button');
                btn.id = `skill-${skillId}`;
                btn.className = 'skill-use-btn';
                btn.onclick = () => useSkill(skillId);
                
                let costText = '';
                if (skill.useCost.type === 'mana') {
                    costText = `ë§ˆë‚˜ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'hp') {
                    costText = `ì²´ë ¥ ${skill.useCost.amount}`;
                }
                if (skill.useCost.mana && skill.useCost.hp) {
                    costText = `ì²´ë ¥ ${skill.useCost.hp} / ë§ˆë‚˜ ${skill.useCost.mana}`;
                }
                
                btn.innerHTML = `
                    ${skill.icon} ${skill.name}
                    <span class="skill-cost-badge">${costText}</span>
                `;
                
                container.appendChild(btn);
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // ê²Œì„ ì´ˆê¸°í™”
        updateDisplay();
        updateRecordsDisplay();
        renderSkillButtons();
        
        setTimeout(() => {
            if (!gameLoaded) {
                generateProblem();
                startBattle();
                startManaRegeneration();
            } else {
                startBattle();
                startManaRegeneration();
            }
        }, 500);
        
        setInterval(updateRecordsDisplay, 1000);
        
        function playHeroAttackSound() {
            const audio = document.getElementById('hero-hit');
            audio.currentTime = 0;
            audio.play();
        }
        
        function playBossAttackSound() {
            const audio = document.getElementById('boss-hit');
            audio.currentTime = 0;
            audio.play();
        }

        function playupgradeSound() {
            const audio = document.getElementById('upgrade-sound');
            audio.currentTime = 0;
            audio.play();
        }
        
        function playhealingSound() {
            const audio = document.getElementById('healing-magic');
            audio.currentTime = 0;
            audio.play();
        }
        
        function playgameoverSound() {
            const audio = document.getElementById('game-over');
            audio.currentTime = 0;
            audio.play();
        }
        
        function triggerHitEffect(targetId) {
            const effectElement = document.getElementById(targetId);
            if (!effectElement) { 
                console.error(`íƒ€ê²© íš¨ê³¼ ìš”ì†Œ(ID: ${targetId})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ íš¨ê³¼ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            effectElement.style.display = 'block';
            setTimeout(() => {
                effectElement.style.display = 'none';
            }, 300); 
        }
    </script>
</body>
</html>