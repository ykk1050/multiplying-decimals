<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prime Battle Academy1.17</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
            
        }

        /* ì½”ì¸ í‘œì‹œ ì˜ì—­ - game-container ìƒë‹¨ ìš°ì¸¡ì— ë°°ì¹˜ */
        .coin-display {
            position: absolute;
            top: 20px;
            right: 30px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 3px solid #ff8c00;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #744210;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .coin-icon {
            font-size: 1.5rem;
        }

        /* í›ˆë ¨ì¥ ë²„íŠ¼ - game-container ìƒë‹¨ ì¢Œì¸¡ì— ë°°ì¹˜ */
        .shop-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(159, 122, 234, 0.4);
            z-index: 100;
        }

        .shop-btn:hover {
            transform: translateY(-3px);
        }

        /* í›ˆë ¨ì¥ ëª¨ë‹¬ (íŒì—…ì°½) */
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .shop-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .shop-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2.5rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .shop-close:hover {
            color: #333;
        }

        .shop-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
            text-align: center;
        }

        .shop-coin-info {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff8c00;
        }

        /* ìŠ¤í‚¬ ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .skill-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border: 3px solid #cbd5e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .skill-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .skill-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .skill-description {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 12px;
            min-height: 40px;
        }

        .skill-cost {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 8px;
        }

        .skill-use-cost {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
        }

        .buy-skill-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .buy-skill-btn:hover {
            transform: scale(1.05);
        }

        .buy-skill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .owned-badge {
            background: #48bb78;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* ìŠ¤í‚¬ ì‚¬ìš© ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .skills-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .skill-use-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .skill-use-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .skill-use-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-cost-badge {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative; /* ì´ ì¤„ ì¶”ê°€ */

        }
        
        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .battle-arena {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .character-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid;
            position: relative;
        }
        
        .player-card {
            border-color: #48bb78;
        }
        
        .villain-card {
            border-color: #f56565;
        }
        
        .character-avatar {
            width: 360px;
            height: 360px;
            margin: 0 auto 20px;
            border-radius: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative; /* âœ¨ [ì¶”ê°€] GIF íš¨ê³¼ì˜ ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì • */
        }

        .hero-attack-gif, .devil-attack-gif {
            position: absolute; /* ë¶€ëª¨(.character-avatar) ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ì„¤ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* ì´ˆê¸°ì—ëŠ” ë³´ì´ì§€ ì•Šë„ë¡ ìˆ¨ê¹€ */
            z-index: 10; /* ìºë¦­í„° ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œë˜ë„ë¡ ë ˆì´ì–´ ìˆœì„œ ì§€ì • */
}
        
        .player-avatar {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .villain-avatar {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        
        .character-name {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-weight: bold;
            min-width: 60px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            background: #e2e8f0;
            border-radius: 10px;
            height: 25px;
            flex: 1;
            position: relative;
            /* overflow: hidden; */
        }
        
        .stat-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .hp-fill { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .attack-fill { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .defense-fill { background: linear-gradient(90deg, #4299e1, #3182ce); }
        .mana-fill { background: linear-gradient(90deg, #9f7aea, #805ad5); }
        
        .battle-log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            height: 120px;
            overflow-y: auto;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .math-section {
            background: linear-gradient(145deg, #fef5e7, #fed7aa);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #f6ad55;
        }
        
        .math-problem {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #744210;
        }
        
        .answer-section {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        

        
        .answer-input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: 3px solid #f6ad55;
            border-radius: 10px;
            text-align: center;
            width: 120px;
            font-weight: bold;
        }
        
        .submit-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .upgrade-section {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .upgrade-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .upgrade-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
        }
        
        .upgrade-btn:hover {
            transform: translateY(-2px);
        }
        
        .upgrade-hp { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .upgrade-attack { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .upgrade-defense { background: linear-gradient(135deg, #4299e1, #3182ce); }
        
        .game-over {
            display: none;
            text-align: center;
            background: linear-gradient(145deg, #fed7d7, #feb2b2);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            border: 3px solid #f56565;
        }
        
        .victory {
            display: none;
            text-align: center;
            background: linear-gradient(145deg, #c6f6d5, #9ae6b4);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            border: 3px solid #48bb78;
        }
        
        .next-level-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }
        
        .next-level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(128, 90, 213, 0.4);
        }
        
        .level-indicator {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #553c9a;
            margin-bottom: 20px;
        }
        
        .records-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #cbd5e0;
        }
        
        .current-stats h3, .best-records h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.3rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 600;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .record-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .record-value {
            font-weight: bold;
            color: #805ad5;
            font-size: 1.1rem;
        }
        
        .new-record {
            animation: recordGlow 2s ease-in-out;
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #744210 !important;
        }
        
        @keyframes recordGlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @media (max-width: 768px) {
            .battle-arena {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .records-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .answer-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .upgrade-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="game-container">
   <h1 class="game-title" id="gameTitle">Prime Battle Academy1.16</h1>  
   <button class="shop-btn" onclick="openShop()">ğŸª í›ˆë ¨ì¥</button>

    <!-- ì½”ì¸ í‘œì‹œ -->
    <div class="coin-display">
        <span class="coin-icon">ğŸª™</span>
        <span id="coinAmount">0</span>
    </div>
    <!-- ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ -->

    <div class="level-indicator" id="levelIndicator"> 

    ë ˆë²¨ 1
   </div>
   <div class="records-section" id="recordsSection">
    <div class="current-stats">
     <h3>ğŸ† í˜„ì¬ í”Œë ˆì´ ê¸°ë¡</h3>
     <div class="stats-grid">
      <div class="stat-item"><span class="stat-number" id="currentLevel">1</span> <span class="stat-label">í˜„ì¬ ë ˆë²¨</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="problemsSolved">0</span> <span class="stat-label">í•´ê²°í•œ ë¬¸ì œ</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="totalDamage">0</span> <span class="stat-label">ì´ í”¼í•´ëŸ‰</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="playTime">0:00</span> <span class="stat-label">í”Œë ˆì´ ì‹œê°„</span>
      </div>
     </div>
    </div>
    <div class="best-records">
     <h3>â­ ìµœê³  ê¸°ë¡</h3>
     <div class="record-item"><span class="record-label">ìµœê³  ë ˆë²¨:</span> <span class="record-value" id="bestLevel">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœë‹¤ ë¬¸ì œ í•´ê²°:</span> <span class="record-value" id="bestProblems">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœëŒ€ ì´ í”¼í•´ëŸ‰:</span> <span class="record-value" id="bestDamage">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœê°• ì²´ë ¥:</span> <span class="record-value" id="bestHp">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœê°• ê³µê²©ë ¥:</span> <span class="record-value" id="bestAttack">-</span>
     </div>
    </div>
   </div>
   <div class="battle-arena">
    <div class="character-card player-card">
     <div class="character-avatar player-avatar">
      <img src="hero.png" alt="ìš©ì‚¬" style="width: 100%; height: 100%; object-fit: cover;">
      <img id="devilattack" src="devilattack.gif" alt="ì•…ë§ˆ íƒ€ê²© íš¨ê³¼" class="devil-attack-gif">
      
     </div>   
     <div class="character-name" id="playerName">
      ìš©ì‚¬
     </div>
     <div class="stats">
      <div class="stat-bar"><span class="stat-label">ì²´ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill hp-fill" id="playerHpBar">
         100/100
        </div>
       </div>
      </div>
      <div class="stat-bar"><span class="stat-label">ê³µê²©ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill attack-fill" id="playerAttackBar">
         15
        </div>
       </div>
      </div>
      <div class="stat-bar"><span class="stat-label">ë°©ì–´ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill defense-fill" id="playerDefenseBar">
         10
        </div>
       </div>
      </div>
      <div class="stat-bar"><span class="stat-label">ë§ˆë‚˜</span>
       <div class="stat-value">
        <div class="stat-fill mana-fill" id="playerManaBar">
         0/20
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="character-card villain-card">
     <div class="character-avatar villain-avatar">
      <img src="devilking.png" alt="ìˆ˜í•™ ë§ˆì™•" style="width: 100%; height: 100%; object-fit: cover;">
      <img id="heroattack" src="heroattack.gif" alt="ìš©ì‚¬ íƒ€ê²© íš¨ê³¼" class="hero-attack-gif">  
      </div>   
     <div class="character-name" id="villainName">
      ìˆ˜í•™ ë§ˆì™•
     </div>
     <div class="stats">
      <div class="stat-bar"><span class="stat-label">ì²´ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill hp-fill" id="villainHpBar">
         80/80
        </div>
       </div>
      </div>
      <div class="stat-bar"><span class="stat-label">ê³µê²©ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill attack-fill" id="villainAttackBar">
         12
        </div>
       </div>
      </div>
      <div class="stat-bar"><span class="stat-label">ë°©ì–´ë ¥</span>
       <div class="stat-value">
        <div class="stat-fill defense-fill" id="villainDefenseBar">
         8
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="battle-log" id="battleLog">
    ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì†Œìˆ˜ ê³±ì…ˆ ë¬¸ì œë¥¼ í’€ì–´ì„œ ìºë¦­í„°ë¥¼ ê°•í™”í•˜ì„¸ìš”!<br>
   </div>
   <div class="math-section">
    <div class="math-problem" id="mathProblem">
     2 Ã— 3 = ?
    </div>
    <div class="answer-section"><input type="number" step="0.001" class="answer-input" id="answerInput" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"> <button class="submit-btn" id="submitBtn">ì œì¶œ</button>
    </div>
    <div class="upgrade-section" id="upgradeSection">
     <h3 style="color: #744210; margin-bottom: 10px;">ì •ë‹µì…ë‹ˆë‹¤! ëŠ¥ë ¥ì¹˜ë¥¼ ì„ íƒí•˜ì—¬ ê°•í™”í•˜ì„¸ìš”:</h3>
     <div class="upgrade-buttons"><button class="upgrade-btn upgrade-hp" onclick="upgradePlayer('hp')">ì²´ë ¥ +20</button> <button class="upgrade-btn upgrade-attack" onclick="upgradePlayer('attack')">ê³µê²©ë ¥ +5</button> <button class="upgrade-btn upgrade-defense" onclick="upgradePlayer('defense')">ë°©ì–´ë ¥ +3</button>
     </div>
    </div>
    <div class="skills-container">
        <button class="upgrade-btn" id="recoveryBtn" onclick="useRecovery()" 
                style="background: linear-gradient(135deg, #9f7aea, #805ad5); font-size: 1.1rem; padding: 12px 25px;" disabled>
            ğŸ”® ë¦¬ì»¤ë²„ë¦¬ (ë§ˆë‚˜ 20)
        </button>
        <!-- ìŠ¤í‚¬ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <div id="skillButtonsContainer" style="display: contents;"></div>
    </div>
    <div style="text-align: center; margin-top: 20px;"><button class="upgrade-btn" id="recoveryBtn" onclick="useRecovery()" style="background: linear-gradient(135deg, #9f7aea, #805ad5); font-size: 1.1rem; padding: 12px 25px;" disabled> ğŸ”® ë¦¬ì»¤ë²„ë¦¬ (ë§ˆë‚˜ 20) </button>
    </div>
   </div>
   <div class="victory" id="victorySection">
    <h2 style="color: #22543d; margin-bottom: 15px;">ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ğŸ‰</h2>
    <p style="color: #2f855a;">ë¹ŒëŸ°ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! ë” ê°•í•œ ì ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.</p><button class="next-level-btn" onclick="nextLevel()">ë‹¤ìŒ ë ˆë²¨ë¡œ</button>
   </div>
   <div class="game-over" id="gameOverSection">
    <h2 style="color: #742a2a; margin-bottom: 15px;">ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤ ğŸ’€</h2>
    <p style="color: #c53030;">ë” ë§ì€ ë¬¸ì œë¥¼ í’€ì–´ì„œ ê°•í•´ì ¸ì•¼ í•©ë‹ˆë‹¤!</p><button class="next-level-btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
   </div>
  </div>

  <div class="shop-modal" id="shopModal" onclick="closeShopOnBackdrop(event)">
    <div class="shop-content" onclick="event.stopPropagation()">
        <button class="shop-close" onclick="closeShop()">Ã—</button>
        <h2 class="shop-title">ğŸª í›ˆë ¨ì¥ - ìŠ¤í‚¬ ìƒì </h2>
        <div class="shop-coin-info">
            ë³´ìœ  ì½”ì¸: <span id="shopCoinAmount">0</span> ğŸª™
        </div>
        <div class="skill-grid" id="skillShop"></div>
    </div>
  </div>


  <audio id="hero-hit" src="quick-swing-sound-419581.mp3"></audio>
  <audio id="boss-hit" src="deadly-strike-352458.mp3"></audio>
  <audio id="upgrade-sound" src="bonus-points-190035.mp3"></audio>
  <audio id="healing-magic" src="healing-magic-4-378668.mp3"></audio>
  <audio id="game-over" src="game-over-417465.mp3"></audio>



  <script>
        // ê²Œì„ ìƒíƒœ
        let gameState = {
            level: 1,
            coins: 0, // ì¶”ê°€
            ownedSkills: [], // ì¶”ê°€
            player: { hp: 100, maxHp: 100, attack: 15, defense: 10, mana: 0, maxMana: 20 },
            villain: { hp: 80, maxHp: 80, attack: 12, defense: 8 },
            currentProblem: { num1: 2, num2: 3, answer: 6 },
            battleInterval: null,
            manaInterval: null,
            gameActive: true,
            // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡
            currentStats: {
                problemsSolved: 0,
                totalDamage: 0,
                startTime: Date.now()
            },
            // ìµœê³  ê¸°ë¡
            bestRecords: {
                level: 0,
                problemsSolved: 0,
                totalDamage: 0,
                maxHp: 0,
                maxAttack: 0,
                maxDefense: 0
            }
        };

        const SKILLS = {
            fireball: {
                id: 'fireball',
                name: 'ğŸ”¥ í™”ì—¼êµ¬',
                description: 'ê°•ë ¥í•œ í™”ì—¼êµ¬ë¥¼ ë°œì‚¬',
                icon: 'ğŸ”¥',
                cost: 50, // êµ¬ë§¤ ë¹„ìš© (ì½”ì¸)
                useCost: { type: 'mana', amount: 15 }, // ì‚¬ìš© ë¹„ìš©
                damage: 40
            },
            lightning: {
                id: 'lightning',
                name: 'âš¡ ë²ˆê°œ',
                description: 'ë¹ ë¥¸ ë²ˆê°œ ê³µê²©',
                icon: 'âš¡',
                cost: 70,
                useCost: { type: 'mana', amount: 18 },
                damage: 50
            },
            meteor: {
                id: 'meteor',
                name: 'â˜„ï¸ ë©”í…Œì˜¤',
                description: 'ê±°ëŒ€í•œ ìš´ì„ ë‚™í•˜',
                icon: 'â˜„ï¸',
                cost: 100,
                useCost: { type: 'mana', amount: 20 },
                damage: 70
            },
            berserk: {
                id: 'berserk',
                name: 'ğŸ’¥ ê´‘í­í™”',
                description: 'ì²´ë ¥ì„ ì†Œëª¨í•´ ê°•íƒ€',
                icon: 'ğŸ’¥',
                cost: 80,
                useCost: { type: 'hp', amount: 15 },
                damage: 45
            },
            ultimate: {
                id: 'ultimate',
                name: 'ğŸŒŸ ê¶ê·¹ê¸°',
                description: 'ìµœê°•ì˜ í•„ì‚´ê¸°!',
                icon: 'ğŸŒŸ',
                cost: 150,
                useCost: { type: 'both', hp: 20, mana: 15 },
                damage: 100
            }
        };

        // ë°ì´í„° ì €ì¥ì„ ìœ„í•œ ë³€ìˆ˜
        let allRecords = [];
        let dataInitialized = false;
        let gameLoaded = false;

        // ì†Œìˆ˜ ë°°ì—´ (100 ì´í•˜)
        const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97];

        // ì„¤ì • ê°ì²´
        const defaultConfig = {
            game_title: "Prime Battle Academy1.1",
            player_name: "ìš©ì‚¬",
            villain_name: "ìˆ˜í•™ ë§ˆì™•"
        };

        // Data SDK ì´ˆê¸°í™”
        const dataHandler = {
            onDataChanged(data) {
                allRecords = data;
                if (!dataInitialized) {
                    loadBestRecords();
                    loadGameProgress();
                    dataInitialized = true;
                }
                updateRecordsDisplay();
            }
        };

        // SDK ì´ˆê¸°í™”
        async function initializeSDKs() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Data SDK ì´ˆê¸°í™” ì‹¤íŒ¨");
                }
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
                        document.getElementById('playerName').textContent = config.player_name || defaultConfig.player_name;
                        const baseVillainName = config.villain_name || defaultConfig.villain_name;
                        document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
                    },
                        /* document.getElementById('villainName').textContent = config.villain_name || defaultConfig.villain_name;
                    }, */
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["game_title", config.game_title || defaultConfig.game_title],
                        ["player_name", config.player_name || defaultConfig.player_name],
                        ["villain_name", config.villain_name || defaultConfig.villain_name]
                    ])
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ SDK ì´ˆê¸°í™”
        initializeSDKs();

        // ê²Œì„ ì§„í–‰ ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
        function loadGameProgress() {
            const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
            
            if (progressRecords.length > 0) {
                // ê°€ì¥ ìµœê·¼ ì§„í–‰ ìƒí™© ì°¾ê¸°
                const latestProgress = progressRecords.reduce((latest, current) => {
                    return new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest;
                });
                
                // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ì—ˆë‹¤ë©´ ë³µì›
                if (latestProgress.game_active) {
                    gameState.level = latestProgress.level;
                    gameState.coins = latestProgress.coins || 0; // ì¶”ê°€
                    gameState.ownedSkills = latestProgress.owned_skills || []; // ì¶”ê°€
                    gameState.player = {
                        hp: latestProgress.player_hp,
                        maxHp: latestProgress.player_max_hp,
                        attack: latestProgress.player_attack,
                        defense: latestProgress.player_defense,
                        mana: latestProgress.player_mana,
                        maxMana: 20
                    };


                    gameState.villain = {
                        hp: latestProgress.villain_hp,
                        maxHp: latestProgress.villain_max_hp,
                        attack: latestProgress.villain_attack,
                        defense: latestProgress.villain_defense
                    };
                    gameState.currentStats.problemsSolved = latestProgress.problems_solved;
                    gameState.currentStats.totalDamage = latestProgress.total_damage;
                    gameState.gameActive = true;
                    gameLoaded = true;
                    
                    addBattleLog(`ì´ì „ ê²Œì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ë ˆë²¨ ${gameState.level}ë¶€í„° ê³„ì†í•©ë‹ˆë‹¤.`);
                    updateDisplay();

                    renderSkillButtons(); // ì¶”ê°€: ìŠ¤í‚¬ ë²„íŠ¼ ë Œë”ë§

                }
            }
        }

        // ê²Œì„ ì§„í–‰ ìƒí™© ì €ì¥
        async function saveGameProgress() {
            if (!window.dataSdk) return;
            
            // ê¸°ì¡´ ì§„í–‰ ìƒí™© ë ˆì½”ë“œ ì‚­ì œ
            const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
            for (const record of progressRecords) {
                await window.dataSdk.delete(record);
            }
            
            // ìƒˆë¡œìš´ ì§„í–‰ ìƒí™© ì €ì¥
            const progressData = {
                record_type: 'game_progress',
                level: gameState.level,
                coins: gameState.coins, // ì¶”ê°€
                owned_skills: gameState.ownedSkills, // ì¶”ê°€
                problems_solved: gameState.currentStats.problemsSolved,
                total_damage: gameState.currentStats.totalDamage,
                max_hp: 0,
                max_attack: 0,
                max_defense: 0,
                play_time: 0,
                player_hp: gameState.player.hp,
                player_max_hp: gameState.player.maxHp,
                player_attack: gameState.player.attack,
                player_defense: gameState.player.defense,
                player_mana: gameState.player.mana,
                villain_hp: gameState.villain.hp,
                villain_max_hp: gameState.villain.maxHp,
                villain_attack: gameState.villain.attack,
                villain_defense: gameState.villain.defense,
                game_active: gameState.gameActive,
                timestamp: new Date().toISOString()
            };
            
            await window.dataSdk.create(progressData);
        }

        // ê¸°ë¡ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function loadBestRecords() {
            const records = allRecords.filter(record => record.record_type === 'best_record');
            if (records.length > 0) {
                const bestRecord = records[0];
                gameState.bestRecords = {
                    level: bestRecord.level || 0,
                    problemsSolved: bestRecord.problems_solved || 0,
                    totalDamage: bestRecord.total_damage || 0,
                    maxHp: bestRecord.max_hp || 0,
                    maxAttack: bestRecord.max_attack || 0,
                    maxDefense: bestRecord.max_defense || 0
                };
            }
        }

        async function saveBestRecords() {
            if (!window.dataSdk) return;

            const existingRecords = allRecords.filter(record => record.record_type === 'best_record');
            
            const recordData = {
                record_type: 'best_record',
                level: gameState.bestRecords.level,
                problems_solved: gameState.bestRecords.problemsSolved,
                total_damage: gameState.bestRecords.totalDamage,
                max_hp: gameState.bestRecords.maxHp,
                max_attack: gameState.bestRecords.maxAttack,
                max_defense: gameState.bestRecords.maxDefense,
                play_time: 0,
                player_hp: 0,
                player_max_hp: 0,
                player_attack: 0,
                player_defense: 0,
                player_mana: 0,
                villain_hp: 0,
                villain_max_hp: 0,
                villain_attack: 0,
                villain_defense: 0,
                game_active: false,
                timestamp: new Date().toISOString()
            };

            if (existingRecords.length > 0) {
                const existingRecord = existingRecords[0];
                const updatedRecord = { ...existingRecord, ...recordData };
                await window.dataSdk.update(updatedRecord);
            } else {
                await window.dataSdk.create(recordData);
            }
        }

        async function saveGameSession() {
            if (!window.dataSdk) return;

            const playTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            
            const sessionData = {
                record_type: 'game_session',
                level: gameState.level,
                problems_solved: gameState.currentStats.problemsSolved,
                total_damage: gameState.currentStats.totalDamage,
                max_hp: gameState.player.maxHp,
                max_attack: gameState.player.attack,
                max_defense: gameState.player.defense,
                play_time: playTime,
                player_hp: 0,
                player_max_hp: 0,
                player_attack: 0,
                player_defense: 0,
                player_mana: 0,
                villain_hp: 0,
                villain_max_hp: 0,
                villain_attack: 0,
                villain_defense: 0,
                game_active: false,
                timestamp: new Date().toISOString()
            };

            await window.dataSdk.create(sessionData);
        }

        function updateBestRecords() {
            let newRecord = false;
            
            if (gameState.level > gameState.bestRecords.level) {
                gameState.bestRecords.level = gameState.level;
                highlightNewRecord('bestLevel');
                newRecord = true;
            }
            
            if (gameState.currentStats.problemsSolved > gameState.bestRecords.problemsSolved) {
                gameState.bestRecords.problemsSolved = gameState.currentStats.problemsSolved;
                highlightNewRecord('bestProblems');
                newRecord = true;
            }
            
            if (gameState.currentStats.totalDamage > gameState.bestRecords.totalDamage) {
                gameState.bestRecords.totalDamage = gameState.currentStats.totalDamage;
                highlightNewRecord('bestDamage');
                newRecord = true;
            }
            
            if (gameState.player.maxHp > gameState.bestRecords.maxHp) {
                gameState.bestRecords.maxHp = gameState.player.maxHp;
                highlightNewRecord('bestHp');
                newRecord = true;
            }
            
            if (gameState.player.attack > gameState.bestRecords.maxAttack) {
                gameState.bestRecords.maxAttack = gameState.player.attack;
                highlightNewRecord('bestAttack');
                newRecord = true;
            }
            
            if (gameState.player.defense > gameState.bestRecords.maxDefense) {
                gameState.bestRecords.maxDefense = gameState.player.defense;
                newRecord = true;
            }
            
            if (newRecord) {
                saveBestRecords();
                addBattleLog('ğŸ‰ ìƒˆë¡œìš´ ìµœê³  ê¸°ë¡ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!');
            }
        }

        function highlightNewRecord(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.parentElement) {
                element.parentElement.classList.add('new-record');
                setTimeout(() => {
                    element.parentElement.classList.remove('new-record');
                }, 2000);
            }
        }

        function updateRecordsDisplay() {
            // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡ ì—…ë°ì´íŠ¸
            document.getElementById('currentLevel').textContent = gameState.level;
            document.getElementById('problemsSolved').textContent = gameState.currentStats.problemsSolved;
            document.getElementById('totalDamage').textContent = gameState.currentStats.totalDamage;
            
            const playTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            const minutes = Math.floor(playTime / 60);
            const seconds = playTime % 60;
            document.getElementById('playTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // ìµœê³  ê¸°ë¡ ì—…ë°ì´íŠ¸
            document.getElementById('bestLevel').textContent = gameState.bestRecords.level || '-';
            document.getElementById('bestProblems').textContent = gameState.bestRecords.problemsSolved || '-';
            document.getElementById('bestDamage').textContent = gameState.bestRecords.totalDamage || '-';
            document.getElementById('bestHp').textContent = gameState.bestRecords.maxHp || '-';
            document.getElementById('bestAttack').textContent = gameState.bestRecords.maxAttack || '-';
        }

        // ìƒˆë¡œìš´ ì†Œìˆ˜ ê³±ì…ˆ ë¬¸ì œ ìƒì„±
        function generateProblem() {
            // ìì—°ìˆ˜ ë°°ì—´ (1-20)
            const naturalNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
            
            // í•œìë¦¬ ì†Œìˆ˜ (0.1 ~ 0.9)
            const oneDigitDecimals = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];
            
            // ë‘ìë¦¬ ì†Œìˆ˜ (0.10 ~ 0.99, 0.05 ê°„ê²©)
            const twoDigitDecimals = [];
            for (let i = 10; i <= 99; i += 5) {
                twoDigitDecimals.push(i / 100);
            }
            
            // ë¬¸ì œ ìœ í˜• ì„ íƒ (1: ìì—°ìˆ˜Ã—ì†Œìˆ˜, 2: ì†Œìˆ˜Ã—ìì—°ìˆ˜, 3: ì†Œìˆ˜Ã—ì†Œìˆ˜)
            const problemType = Math.floor(Math.random() * 3) + 1;
            let num1, num2, answer;
            
            if (problemType === 1) {
                // ìì—°ìˆ˜ Ã— ì†Œìˆ˜ (í•œìë¦¬ ë˜ëŠ” ë‘ìë¦¬)
                num1 = naturalNumbers[Math.floor(Math.random() * naturalNumbers.length)];
                const useOneDigit = Math.random() < 0.5;
                if (useOneDigit) {
                    num2 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                } else {
                    num2 = twoDigitDecimals[Math.floor(Math.random() * twoDigitDecimals.length)];
                }
            } else if (problemType === 2) {
                // ì†Œìˆ˜ Ã— ìì—°ìˆ˜
                const useOneDigit = Math.random() < 0.5;
                if (useOneDigit) {
                    num1 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                } else {
                    num1 = twoDigitDecimals[Math.floor(Math.random() * twoDigitDecimals.length)];
                }
                num2 = naturalNumbers[Math.floor(Math.random() * naturalNumbers.length)];
            } else {
                // ì†Œìˆ˜ Ã— ì†Œìˆ˜ (ë‘˜ ë‹¤ í•œìë¦¬)
                num1 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                num2 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
            }
            
            answer = Math.round((num1 * num2) * 1000) / 1000; // ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
            
            gameState.currentProblem = { num1, num2, answer };
            document.getElementById('mathProblem').textContent = `${num1} Ã— ${num2} = ?`;
            document.getElementById('answerInput').value = '';
            document.getElementById('upgradeSection').style.display = 'none';
        }

        // ë‹µì•ˆ í™•ì¸
        function checkAnswer() {
            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const correctAnswer = gameState.currentProblem.answer;
            
            // ì†Œìˆ˜ì  ê³„ì‚°ì˜ ì˜¤ì°¨ë¥¼ ê³ ë ¤í•˜ì—¬ 0.001 ë²”ìœ„ ë‚´ì—ì„œ ì •ë‹µ ì²˜ë¦¬
            if (Math.abs(userAnswer - correctAnswer) < 0.001) {
                const coinsEarned = 5;
                gameState.coins += coinsEarned;
                addBattleLog(`ì •ë‹µì…ë‹ˆë‹¤! ${gameState.currentProblem.num1} Ã— ${gameState.currentProblem.num2} = ${correctAnswer}`);
                gameState.currentStats.problemsSolved++;
                updateBestRecords();
                updateRecordsDisplay();
                document.getElementById('upgradeSection').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
            } else {
                addBattleLog(`í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”!`);
                document.getElementById('answerInput').value = '';
            }
        }

        // í”Œë ˆì´ì–´ ê°•í™”
        function upgradePlayer(stat) {
            switch(stat) {
                case 'hp':
                    gameState.player.maxHp += 20;
                    gameState.player.hp += 20;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ì²´ë ¥ì´ 20 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
                case 'attack':
                    gameState.player.attack += 5;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ê³µê²©ë ¥ì´ 5 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
                case 'defense':
                    gameState.player.defense += 3;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ë°©ì–´ë ¥ì´ 3 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
            }
            
            updateDisplay();
            saveGameProgress();
            generateProblem();
            document.getElementById('submitBtn').disabled = false;
        }

        // ë§ˆë‚˜ íšŒë³µ ì‹œìŠ¤í…œ
        function startManaRegeneration() {
            if (gameState.manaInterval) {
                clearInterval(gameState.manaInterval);
            }
            
            gameState.manaInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                if (gameState.player.mana < gameState.player.maxMana) {
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + 1);
                    updateDisplay();
                }
            }, 2000); // 2ì´ˆë§ˆë‹¤ ë§ˆë‚˜ 1ì”© íšŒë³µ
        }

        // ë¦¬ì»¤ë²„ë¦¬ ë§ˆë²• ì‚¬ìš©
        function useRecovery() {
            if (gameState.player.mana >= 20) {
                gameState.player.mana -= 20;
                gameState.player.hp = gameState.player.maxHp;
                addBattleLog(`ğŸ”® ë¦¬ì»¤ë²„ë¦¬ ë§ˆë²•ìœ¼ë¡œ ì²´ë ¥ì„ ì™„ì „ íšŒë³µí–ˆìŠµë‹ˆë‹¤!`);
                playhealingSound()
                updateDisplay();
                saveGameProgress();

            }
        }

        // ì „íˆ¬ ì‹œìŠ¤í…œ
        function startBattle() {
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
            }
            
            gameState.battleInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                // í”Œë ˆì´ì–´ ê³µê²©
                const playerDamage = Math.max(1, gameState.player.attack - gameState.villain.defense);
                gameState.villain.hp = Math.max(0, gameState.villain.hp - playerDamage);
                gameState.currentStats.totalDamage += playerDamage;
                updateRecordsDisplay();
                addBattleLog(`${document.getElementById('playerName').textContent}ì´(ê°€) ${playerDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                playHeroAttackSound(); 
                
                // âœ¨ [ìˆ˜ì •] ë§ˆì™•ì—ê²ŒëŠ” ìš©ì‚¬ ê³µê²© íš¨ê³¼(ID: 'heroattack')ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                triggerHitEffect('heroattack'); 

                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
                
                // ë¹ŒëŸ° ê³µê²©
                setTimeout(() => {
                    if (!gameState.gameActive) return;
                    
                    const villainDamage = Math.max(1, gameState.villain.attack - gameState.player.defense);
                    gameState.player.hp = Math.max(0, gameState.player.hp - villainDamage);
                    addBattleLog(`${document.getElementById('villainName').textContent}ì´(ê°€) ${villainDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                    playBossAttackSound(); 
                    
                    // âœ¨ [ìˆ˜ì •] ìš©ì‚¬ì—ê²ŒëŠ” ì•…ë§ˆ ê³µê²© íš¨ê³¼(ID: 'devilattack')ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    triggerHitEffect('devilattack'); 
                    
                    if (gameState.player.hp <= 0) {
                        gameOver();
                        return;
                    }
                    
                    updateDisplay();
                    saveGameProgress();
                }, 1500);
                
                updateDisplay();
                saveGameProgress();
            }, 3000);
        }

        /* // ì „íˆ¬ ì‹œìŠ¤í…œ
        function startBattle() {
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
            }
            
            gameState.battleInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                // í”Œë ˆì´ì–´ ê³µê²©
                const playerDamage = Math.max(1, gameState.player.attack - gameState.villain.defense);
                gameState.villain.hp = Math.max(0, gameState.villain.hp - playerDamage);
                gameState.currentStats.totalDamage += playerDamage;
                updateRecordsDisplay();
                addBattleLog(`${document.getElementById('playerName').textContent}ì´(ê°€) ${playerDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                playHeroAttackSound(); // âœ¨ ì—¬ê¸°ì— ìš©ì‚¬ ê³µê²© ì†Œë¦¬ ì¶”ê°€!
                triggerHitEffect('devil-attack-gif'); // âœ¨ [ì¶”ê°€] ë§ˆì™•ì—ê²Œ íƒ€ê²© íš¨ê³¼ ì¶œë ¥

                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
                
                // ë¹ŒëŸ° ê³µê²©
                setTimeout(() => {
                    if (!gameState.gameActive) return;
                    
                    const villainDamage = Math.max(1, gameState.villain.attack - gameState.player.defense);
                    gameState.player.hp = Math.max(0, gameState.player.hp - villainDamage);
                    addBattleLog(`${document.getElementById('villainName').textContent}ì´(ê°€) ${villainDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                    playBossAttackSound(); // âœ¨ ì—¬ê¸°ì— ë§ˆì™• ê³µê²© ì†Œë¦¬ ì¶”ê°€!
                    triggerHitEffect('hero-attack-gif'); // âœ¨ [ì¶”ê°€] ìš©ì‚¬ì—ê²Œ íƒ€ê²© íš¨ê³¼ ì¶œë ¥
                    if (gameState.player.hp <= 0) {
                        gameOver();
                        return;
                    }
                    
                    updateDisplay();
                    saveGameProgress();
                }, 1500);
                
                updateDisplay();
                saveGameProgress();
            }, 3000);
        } */

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateDisplay() {

            // ì½”ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ì¶”ê°€
            document.getElementById('coinAmount').textContent = gameState.coins;
            document.getElementById('shopCoinAmount').textContent = gameState.coins;
            // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('playerHpBar').style.width = `${playerHpPercent}%`;
            document.getElementById('playerHpBar').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('playerAttackBar').textContent = gameState.player.attack;
            document.getElementById('playerDefenseBar').textContent = gameState.player.defense;
            
            // ë§ˆë‚˜ ë°” ì—…ë°ì´íŠ¸
            const playerManaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            document.getElementById('playerManaBar').style.width = `${playerManaPercent}%`;
            document.getElementById('playerManaBar').textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            
            // ë¦¬ì»¤ë²„ë¦¬ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const recoveryBtn = document.getElementById('recoveryBtn');
            if (gameState.player.mana >= 20) {
                recoveryBtn.disabled = false;
                recoveryBtn.style.opacity = '1';
            } else {
                recoveryBtn.disabled = true;
                recoveryBtn.style.opacity = '0.6';
            }
            
            // ë¹ŒëŸ° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const villainHpPercent = (gameState.villain.hp / gameState.villain.maxHp) * 100;
            document.getElementById('villainHpBar').style.width = `${villainHpPercent}%`;
            document.getElementById('villainHpBar').textContent = `${gameState.villain.hp}/${gameState.villain.maxHp}`;
            document.getElementById('villainAttackBar').textContent = gameState.villain.attack;
            document.getElementById('villainDefenseBar').textContent = gameState.villain.defense;
            
            // ë ˆë²¨ í‘œì‹œ
            document.getElementById('levelIndicator').textContent = `ë ˆë²¨ ${gameState.level}`;

            // âœ¨ [ì¶”ê°€] ë§ˆì™• ì´ë¦„ì— ë ˆë²¨ í‘œì‹œ
            let baseVillainName = defaultConfig.villain_name;
            if (window.elementSdk && window.elementSdk.config && window.elementSdk.config.villain_name) {
                baseVillainName = window.elementSdk.config.villain_name;
            }
            document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
        }

        // í›ˆë ¨ì¥ ì—´ê¸°
        function openShop() {
            document.getElementById('shopModal').style.display = 'flex';
            renderShop();
        }

        // í›ˆë ¨ì¥ ë‹«ê¸°
        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
        }

        // ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        function closeShopOnBackdrop(event) {
            if (event.target.id === 'shopModal') {
                closeShop();
            }
        }

        // ìƒì  ë Œë”ë§
        function renderShop() {
            const shopElement = document.getElementById('skillShop');
            shopElement.innerHTML = '';
            
            Object.values(SKILLS).forEach(skill => {
                const owned = gameState.ownedSkills.includes(skill.id);
                const canBuy = gameState.coins >= skill.cost && !owned;
                
                const card = document.createElement('div');
                card.className = 'skill-card';
                
                let useCostText = '';
                if (skill.useCost.type === 'mana') {
                    useCostText = `ë§ˆë‚˜ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'hp') {
                    useCostText = `ì²´ë ¥ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'both') {
                    useCostText = `ì²´ë ¥ ${skill.useCost.hp} / ë§ˆë‚˜ ${skill.useCost.mana}`;
                }
                
                card.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-description">${skill.description}</div>
                    <div class="skill-cost">ğŸ’° ${skill.cost} ì½”ì¸</div>
                    <div class="skill-use-cost">ì‚¬ìš©: ${useCostText}</div>
                    <div class="skill-use-cost">ë°ë¯¸ì§€: ${skill.damage}</div>
                    ${owned ? 
                        '<div class="owned-badge">âœ… ë³´ìœ ì¤‘</div>' :
                        `<button class="buy-skill-btn" onclick="buySkill('${skill.id}')" ${!canBuy ? 'disabled' : ''}>
                            êµ¬ë§¤í•˜ê¸°
                        </button>`
                    }
                `;
                shopElement.appendChild(card);
            });
        }

        // ìŠ¤í‚¬ êµ¬ë§¤
        function buySkill(skillId) {
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            if (gameState.coins < skill.cost) {
                addBattleLog('âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }
            
            if (gameState.ownedSkills.includes(skillId)) {
                addBattleLog('âŒ ì´ë¯¸ ë³´ìœ í•œ ìŠ¤í‚¬ì…ë‹ˆë‹¤!');
                return;
            }
            
            gameState.coins -= skill.cost;
            gameState.ownedSkills.push(skillId);
            
            addBattleLog(`âœ¨ ${skill.name} ìŠ¤í‚¬ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`);
            playupgradeSound();
            
            renderShop();
            renderSkillButtons();
            updateDisplay();
            saveGameProgress();
        }

        // ìŠ¤í‚¬ ë²„íŠ¼ ë Œë”ë§
        function renderSkillButtons() {
            const container = document.getElementById('skillButtonsContainer');
            container.innerHTML = '';
            
            gameState.ownedSkills.forEach(skillId => {
                const skill = SKILLS[skillId];
                if (!skill) return;
                
                const btn = document.createElement('button');
                btn.id = `skill-${skillId}`;
                btn.className = 'skill-use-btn';
                btn.onclick = () => useSkill(skillId);
                
                let costText = '';
                if (skill.useCost.type === 'mana') {
                    costText = `ë§ˆë‚˜ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'hp') {
                    costText = `ì²´ë ¥ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'both') {
                    costText = `HP ${skill.useCost.hp} / MP ${skill.useCost.mana}`;
                }
                
                btn.innerHTML = `
                    <span>${skill.icon} ${skill.name}</span>
                    <span class="skill-cost-badge">${costText}</span>
                `;
                
                container.appendChild(btn);
            });
        }

        // ìŠ¤í‚¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSkillButtons() {
            gameState.ownedSkills.forEach(skillId => {
                const btn = document.getElementById(`skill-${skillId}`);
                if (!btn) return;
                
                const skill = SKILLS[skillId];
                let canUse = true;
                
                if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                    canUse = false;
                } else if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                    canUse = false;
                } else if (skill.useCost.type === 'both') {
                    if (gameState.player.hp <= skill.useCost.hp || gameState.player.mana < skill.useCost.mana) {
                        canUse = false;
                    }
                }
                
                btn.disabled = !canUse;
                btn.style.opacity = canUse ? '1' : '0.5';
            });
        }

        // ìŠ¤í‚¬ ì‚¬ìš©
        function useSkill(skillId) {
            if (!gameState.gameActive) return;
            
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            // ë¹„ìš© ì²´í¬
            if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                addBattleLog(`âŒ ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                addBattleLog(`âŒ ì²´ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.type === 'both') {
                if (gameState.player.hp <= skill.useCost.hp || gameState.player.mana < skill.useCost.mana) {
                    addBattleLog(`âŒ ì²´ë ¥ ë˜ëŠ” ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!`);
                    return;
                }
            }
            
            // ë¹„ìš© ì°¨ê°
            if (skill.useCost.type === 'mana') {
                gameState.player.mana -= skill.useCost.amount;
            } else if (skill.useCost.type === 'hp') {
                gameState.player.hp -= skill.useCost.amount;
            } else if (skill.useCost.type === 'both') {
                gameState.player.hp -= skill.useCost.hp;
                gameState.player.mana -= skill.useCost.mana;
            }
            
            // ë°ë¯¸ì§€ ì ìš©
            const damage = skill.damage;
            gameState.villain.hp = Math.max(0, gameState.villain.hp - damage);
            gameState.currentStats.totalDamage += damage;
            
            addBattleLog(`${skill.icon} ${skill.name} ì‚¬ìš©! ${damage} ë°ë¯¸ì§€!`);
            playHeroAttackSound();
            triggerHitEffect('heroattack');
            
            if (gameState.villain.hp <= 0) {
                victory();
                return;
            }
            
            updateDisplay();
            saveGameProgress();
        }    


        // ì „íˆ¬ ë¡œê·¸ ì¶”ê°€
        function addBattleLog(message) {
            const log = document.getElementById('battleLog');
            log.innerHTML += message + '<br>';
            log.scrollTop = log.scrollHeight;
        }

        // ìŠ¹ë¦¬
        function victory() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            // ë¬¸ì œ í’€ì´ ë¹„í™œì„±í™”
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('answerInput').style.opacity = '0.6';
            document.getElementById('submitBtn').style.opacity = '0.6';
            
            // ê¸°ë¡ ì—…ë°ì´íŠ¸ ë° ì €ì¥
            updateBestRecords();
            saveGameSession();
            saveGameProgress();
            
            document.getElementById('victorySection').style.display = 'block';
            addBattleLog(`ğŸ‰ ë ˆë²¨ ${gameState.level} í´ë¦¬ì–´! ğŸ‰`);
            addBattleLog('ë‹¤ìŒ ë ˆë²¨ë¡œ ì§„í–‰í•˜ì„¸ìš”!');
        }

        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            // ê¸°ë¡ ì €ì¥
            updateBestRecords();
            saveGameSession();
            
            // ì§„í–‰ ìƒí™© ì‚­ì œ (ê²Œì„ì˜¤ë²„ ì‹œ ì €ì¥ëœ ì§„í–‰ ìƒí™© ì œê±°)
            const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
            progressRecords.forEach(async (record) => {
                if (window.dataSdk) {
                    await window.dataSdk.delete(record);
                }
            });
            
            document.getElementById('gameOverSection').style.display = 'block';
            addBattleLog('ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ğŸ’€');
            playgameoverSound()
        }

        // ë‹¤ìŒ ë ˆë²¨
        function nextLevel() {
            gameState.level++;
            gameState.gameActive = true;
            
            // ë¹ŒëŸ° ê°•í™”
            const levelMultiplier = 1 + (gameState.level - 1) * 0.3;
            gameState.villain = {
                hp: Math.floor(80 * levelMultiplier),
                maxHp: Math.floor(80 * levelMultiplier),
                attack: Math.floor(12 * levelMultiplier),
                defense: Math.floor(8 * levelMultiplier)
            };
            
            // UI ì´ˆê¸°í™”
            document.getElementById('victorySection').style.display = 'none';
            document.getElementById('gameOverSection').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';
            
            // ë¬¸ì œ í’€ì´ ì¬í™œì„±í™”
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            addBattleLog(`ë ˆë²¨ ${gameState.level} ì‹œì‘! ë” ê°•í•œ ${document.getElementById('villainName').textContent}ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
            
            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            gameState = {
                level: 1,
                coins: 0, // ì´ˆê¸°í™”
                ownedSkills: [], // ì´ˆê¸°í™”
                player: { hp: 100, maxHp: 100, attack: 15, defense: 10, mana: 0, maxMana: 20 },
                villain: { hp: 80, maxHp: 80, attack: 12, defense: 8 },
                currentProblem: { num1: 2, num2: 3, answer: 6 },
                battleInterval: null,
                manaInterval: null,
                gameActive: true,
                // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡ ì´ˆê¸°í™”
                currentStats: {
                    problemsSolved: 0,
                    totalDamage: 0,
                    startTime: Date.now()
                },
                // ìµœê³  ê¸°ë¡ì€ ìœ ì§€
                bestRecords: gameState.bestRecords
            };
            
            document.getElementById('gameOverSection').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';
            
            // ë¬¸ì œ í’€ì´ ì¬í™œì„±í™”
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            document.getElementById('battleLog').innerHTML = 'ê²Œì„ì´ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!<br>';
            
            renderSkillButtons(); // ì¶”ê°€

            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // ê²Œì„ ì´ˆê¸°í™”
        updateDisplay();
        updateRecordsDisplay();
        renderSkillButtons(); // ì´ ì¤„ ì¶”ê°€

        
        // ë°ì´í„°ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ê²Œì„ ì‹œì‘
        setTimeout(() => {
            if (!gameLoaded) {
                // ì €ì¥ëœ ê²Œì„ì´ ì—†ìœ¼ë©´ ìƒˆ ê²Œì„ ì‹œì‘
                generateProblem();
                startBattle();
                startManaRegeneration();
            } else {
                // ì €ì¥ëœ ê²Œì„ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‹œì‘
                startBattle();
                startManaRegeneration();
            }
        }, 500);
        
        // ê¸°ë¡ í‘œì‹œ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
        setInterval(updateRecordsDisplay, 1000);
        function playHeroAttackSound() {
        const audio = document.getElementById('hero-hit');
        audio.currentTime = 0;
        audio.play();
      }
        function playBossAttackSound() {
            const audio = document.getElementById('boss-hit');
            audio.currentTime = 0;
            audio.play();
        }

        function playupgradeSound() {
            const audio = document.getElementById('upgrade-sound');
            audio.currentTime = 0;
            audio.play();
        }
        function playhealingSound() {
        const audio = document.getElementById('healing-magic');
        audio.currentTime = 0;
        audio.play();
      }
        function playgameoverSound() {
        const audio = document.getElementById('game-over');
        audio.currentTime = 0;
        audio.play();
      }
        // íƒ€ê²© íš¨ê³¼ë¥¼ ì¶œë ¥í•˜ê³  ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        function triggerHitEffect(targetId) {
            const effectElement = document.getElementById(targetId);

            // âœ¨ [ì•ˆì „ ì¥ì¹˜ ì¶”ê°€] ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í•˜ë©´(null) ì˜¤ë¥˜ ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!effectElement) { 
            console.error(`íƒ€ê²© íš¨ê³¼ ìš”ì†Œ(ID: ${targetId})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ íš¨ê³¼ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
    }
            
            // 1. íš¨ê³¼ ì¶œë ¥ (display: blockìœ¼ë¡œ ë³€ê²½)
            effectElement.style.display = 'block';
            
            // 2. ì ì‹œ í›„ íš¨ê³¼ ìˆ¨ê¹€ (300ms = 0.3ì´ˆ)
            setTimeout(() => {
                effectElement.style.display = 'none';
            }, 300); 
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99d1eb14d076ea9f',t:'MTc2MjkwNzQwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>