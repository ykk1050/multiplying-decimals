<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì†Œìˆ˜ì˜ ê²€: ìˆ˜í•™ ì•…ë§ˆ ì „ìŸ1.382</title>
  <style>
        * {
            box-sizing: border-box;
        }
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 5px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;  /* ì¶”ê°€ */

            color: #333;
            
        }

        /* ì½”ì¸ í‘œì‹œ ì˜ì—­ - game-container ìƒë‹¨ ìš°ì¸¡ì— ë°°ì¹˜ */
        .coin-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 3px solid #ff8c00;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #744210;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .coin-icon {
            font-size: 1.5rem;
        }

        /* í›ˆë ¨ì¥/ë­í‚¹ ë²„íŠ¼ - ê¸°ë¡ ì„¹ì…˜ ë‚´ë¶€ ë°°ì¹˜ */
        .shop-btn, .ranking-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(159, 122, 234, 0.3);
        }

        .ranking-btn {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            box-shadow: 0 2px 8px rgba(246, 173, 85, 0.3);
        }

        .shop-btn:hover, .ranking-btn:hover {
            transform: translateY(-2px);
        }

        /* ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€ */
        /* ì¹˜íŠ¸ ëª¨ë‹¬ */
        .cheat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .cheat-content {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
        }

        .cheat-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .cheat-input {
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #ffd700;
            border-radius: 10px;
            text-align: center;
            width: 200px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .cheat-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #744210;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cheat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        .cheat-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #ffd700;
            background: none;
            border: none;
        }

        /* ë­í‚¹ ëª¨ë‹¬ */
        .ranking-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .ranking-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .ranking-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2.5rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .ranking-close:hover {
            color: #333;
        }

        .ranking-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
            text-align: center;
        }

        .ranking-subtitle {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1rem;
            color: #718096;
        }

        /* ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ì„¹ì…˜ */
        .username-section {
            background: linear-gradient(145deg, #e6fffa, #b2f5ea);
            border: 2px solid #38b2ac;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .username-input {
            padding: 10px 20px;
            font-size: 1.1rem;
            border: 2px solid #38b2ac;
            border-radius: 10px;
            text-align: center;
            width: 200px;
            font-weight: bold;
            margin-right: 10px;
        }

        .username-save-btn {
            padding: 10px 25px;
            background: linear-gradient(135deg, #38b2ac, #319795);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .username-save-btn:hover {
            transform: translateY(-2px);
        }

        .current-username {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #2c7a7b;
        }

        /* ë­í‚¹ íƒ­ */
        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .ranking-tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ranking-tab.active {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            color: white;
        }

        .ranking-tab:hover {
            transform: translateY(-2px);
        }

        /* ë­í‚¹ í…Œì´ë¸” */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ranking-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 1rem;
        }

        .ranking-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .ranking-table tr:hover {
            background: #f7fafc;
        }

        .rank-medal {
            font-size: 1.5rem;
            margin-right: 5px;
        }

        .my-rank {
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 1.1rem;
        }

        /* í›ˆë ¨ì¥ ëª¨ë‹¬ (íŒì—…ì°½) */
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }



        /* ìŠ¹ë¦¬/íŒ¨ë°° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .result-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .shop-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .shop-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2.5rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .shop-close:hover {
            color: #333;
        }

        .shop-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
            text-align: center;
        }

        .shop-coin-info {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff8c00;
        }

        /* ìŠ¤í‚¬ ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .skill-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border: 3px solid #cbd5e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .skill-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .skill-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .skill-description {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 12px;
            min-height: 40px;
        }

        .skill-cost {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 8px;
        }

        .skill-use-cost {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
        }

        .buy-skill-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .buy-skill-btn:hover {
            transform: scale(1.05);
        }

        .buy-skill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .owned-badge {
            background: #48bb78;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* ìŠ¤í‚¬ ì‚¬ìš© ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .skills-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .skill-use-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .skill-use-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .skill-use-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-cost-badge {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .game-container {
            width: 100%;  /* ì¶”ê°€ */
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative; /* ì´ ì¤„ ì¶”ê°€ */

        }
        
        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .battle-arena {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 30px;
            position: relative; /* ì¶”ê°€ */

        }
        
        .character-card {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid;
            position: relative;
            display: flex;  /* ì¶”ê°€ */
            flex-direction: column;  /* ì¶”ê°€ */
        }

        .character-content {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
        }   

        .character-left {
            flex-shrink: 0;
        }

        .character-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .player-card {
            border-color: #48bb78;
        }
        
        .villain-card {
            border-color: #f56565;
        }
        
        .character-avatar {
            width: 120px;
            height: 120px;
            margin: 0;
            border-radius: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .hero-attack-gif, .devil-attack-gif {
            position: absolute; /* ë¶€ëª¨(.character-avatar) ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ì„¤ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* ì´ˆê¸°ì—ëŠ” ë³´ì´ì§€ ì•Šë„ë¡ ìˆ¨ê¹€ */
            z-index: 10; /* ìºë¦­í„° ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œë˜ë„ë¡ ë ˆì´ì–´ ìˆœì„œ ì§€ì • */
}
        
        .player-avatar {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .villain-avatar {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        
        .character-name {
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-weight: bold;
            min-width: 60px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            background: #e2e8f0;
            border-radius: 10px;
            height: 25px;
            flex: 1;
            position: relative;
            /* overflow: hidden; */
        }
        
        .stat-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .hp-fill { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .attack-fill { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .defense-fill { background: linear-gradient(90deg, #4299e1, #3182ce); }
        .mana-fill { background: linear-gradient(90deg, #9f7aea, #805ad5); }
        
    
        .battle-log {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 20px;
        height: 100px;
        overflow-y: auto;
        margin-bottom: 0px;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        /* ê¸°ì¡´ !important ì‚­ì œí•˜ê³  ì•„ë˜ ì¶”ê°€ */
        position: relative;
        display: block;
        
    }
        
        .math-section {
            background: linear-gradient(145deg, #fef5e7, #fed7aa);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #f6ad55;
        }
        
        .math-problem {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #744210;
        }
        
        .answer-section {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        

        
        .answer-input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: 3px solid #f6ad55;
            border-radius: 10px;
            text-align: center;
            width: 120px;
            font-weight: bold;
        }
        
        .submit-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .upgrade-section {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .upgrade-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .upgrade-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
        }
        
        .upgrade-btn:hover {
            transform: translateY(-2px);
        }
        
        .upgrade-hp { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .upgrade-attack { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .upgrade-defense { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .upgrade-mana { background: linear-gradient(135deg, #9f7aea, #805ad5); }


        .game-over {
            text-align: center;
            background: linear-gradient(145deg, #fed7d7, #feb2b2);
            border-radius: 15px;
            padding: 30px;
            border: 3px solid #f56565;
        }
        
        .victory {
            
            text-align: center;
            background: linear-gradient(145deg, #c6f6d5, #9ae6b4);
            border-radius: 15px;
            padding: 30px;
            
            border: 3px solid #48bb78;
        }
        
        .next-level-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }
        
        .next-level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(128, 90, 213, 0.4);
        }
        
        .level-indicator {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #553c9a;
            margin-bottom: 20px;
        }
        
        .records-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #cbd5e0;
        }
        
        .current-stats h3, .best-records h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.3rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 600;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .record-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .record-value {
            font-weight: bold;
            color: #805ad5;
            font-size: 1.1rem;
        }
        
        .new-record {
            animation: recordGlow 2s ease-in-out;
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #744210 !important;
        }
        
        @keyframes recordGlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @media (max-width: 768px) {
            .battle-arena {
                grid-template-columns: 1fr;
                gap: 20px;
            }



            
            .battle-log {
                height: 200px;  /* ëª¨ë°”ì¼ì—ì„œëŠ” ë†’ì´ ì¶•ì†Œ */
            }
            
            .records-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .answer-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .upgrade-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        /* ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€! */
        @media (min-width: 768px) and (orientation: portrait), 
               (min-width: 1024px) {
            body {
                padding: 20px;
            }
            
            .game-container {
                padding: 30px;
            }
            
            .coin-display {
                top: 20px;
                right: 30px;
            }
            
            .shop-btn {
                top: 20px;
                left: 30px;
            }
            
            .ranking-btn {
                top: 20px;
            }
            
            .battle-arena {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .character-avatar {
                width: 200px;
                height: 200px;
            }
        }
        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        @media (max-width: 1023px) and (orientation: landscape) {
            .game-container {
                max-width: 100%;
                width: 100%;
            }
            
            body {
                padding: 5px;
            }
        }

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="game-container">
   <h1 class="game-title" id="gameTitle">ì†Œìˆ˜ì˜ ê²€: ìˆ˜í•™ ì•…ë§ˆ ì „ìŸ1.382</h1>  
   <button class="ranking-btn" onclick="openCheat()" style="left: 330px;">ğŸ® ê°œë°œì ê¸°ëŠ¥</button>

 
    <!-- ì½”ì¸ í‘œì‹œ -->
    <div class="coin-display">
        <span class="coin-icon">ğŸ’°</span>
        <span id="coinAmount">0</span>
    </div>
    <!-- ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ -->

    <div class="level-indicator" id="levelIndicator"> 

    ë ˆë²¨ 1
   </div>
   <div class="records-section" id="recordsSection">
    <div class="current-stats">
     <h3>ğŸ† í˜„ì¬ í”Œë ˆì´ ê¸°ë¡</h3>
     <div class="stats-grid">
      <div class="stat-item"><span class="stat-number" id="currentLevel">1</span> <span class="stat-label">í˜„ì¬ ë ˆë²¨</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="problemsSolved">0</span> <span class="stat-label">í•´ê²°í•œ ë¬¸ì œ</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="totalDamage">0</span> <span class="stat-label">ì´ í”¼í•´ëŸ‰</span>
      </div>
      <div class="stat-item"><span class="stat-number" id="playTime">0:00</span> <span class="stat-label">í”Œë ˆì´ ì‹œê°„</span>
      </div>
     </div>

     <!-- ğŸ‘‡ ì—¬ê¸°ì— ë²„íŠ¼ ì¶”ê°€ -->
     <div style="display: flex; gap: 10px; margin-top: 100px; justify-content: center;">
         <button class="shop-btn" onclick="openShop()" style="position: static; flex: 1;">
             ğŸª ê¸°ìˆ ìƒì 
         </button>
         <button class="ranking-btn" onclick="openRanking()" style="position: static; flex: 1;">
             ğŸ† ë­í‚¹
         </button>
     </div>
    

    </div>
    <div class="best-records">
     <h3>â­ ìµœê³  ê¸°ë¡</h3>
     <div class="record-item"><span class="record-label">ìµœê³  ë ˆë²¨:</span> <span class="record-value" id="bestLevel">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœë‹¤ ë¬¸ì œ í•´ê²°:</span> <span class="record-value" id="bestProblems">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœëŒ€ ì´ í”¼í•´ëŸ‰:</span> <span class="record-value" id="bestDamage">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœê°• ì²´ë ¥:</span> <span class="record-value" id="bestHp">-</span>
     </div>
     <div class="record-item"><span class="record-label">ìµœê°• ê³µê²©ë ¥:</span> <span class="record-value" id="bestAttack">-</span>
     </div>
     

     
     <!-- ğŸ‘‡ ì´ ë¶€ë¶„ ì¶”ê°€ -->
     <div style="text-align: center; margin-top: 15px;">
         <button onclick="resetBestRecords()" style="padding: 8px 20px; background: linear-gradient(135deg, #f56565, #e53e3e); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
             ğŸ”„ ê¸°ë¡ ì´ˆê¸°í™”
         </button>
    </div>
   </div>
   <div class="battle-arena">
    <!-- ìš©ì‚¬ ì¹´ë“œ -->
    <div class="character-card player-card">
        <div class="character-name" id="playerName">
            ìš©ì‚¬
        </div>
        <div class="character-content">
            <div class="character-left">
                <div class="character-avatar player-avatar">
                    <img src="hero.png" alt="ìš©ì‚¬" style="width: 100%; height: 100%; object-fit: cover;">
                    <img id="devilattack" src="devilattack.gif" alt="ì•…ë§ˆ íƒ€ê²© íš¨ê³¼" class="devil-attack-gif">
                    <img id="firebreak" src="firbreak.gif" alt="ë¶ˆê½ƒ ê³µê²©" class="devil-attack-gif">  <!-- ì¶”ê°€ -->

                </div>
            </div>
            <div class="character-right">
                <div class="stats">
                    <div class="stat-bar"><span class="stat-label">ì²´ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill hp-fill" id="playerHpBar">
                                100/100
                            </div>
                        </div>
                    </div>
                    <div class="stat-bar"><span class="stat-label">ê³µê²©ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill attack-fill" id="playerAttackBar">
                                15
                            </div>
                        </div>
                    </div>
                    <div class="stat-bar"><span class="stat-label">ë°©ì–´ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill defense-fill" id="playerDefenseBar">
                                10
                            </div>
                        </div>
                    </div>
                    <div class="stat-bar"><span class="stat-label">ë§ˆë‚˜</span>
                        <div class="stat-value">
                            <div class="stat-fill mana-fill" id="playerManaBar">
                                20/20
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë§ˆì™• ì¹´ë“œ -->
    <div class="character-card villain-card">
        <div class="character-name" id="villainName">
            ìˆ˜í•™ ë§ˆì™•
        </div>
        <div class="character-content">
            <div class="character-left">
                <div class="character-avatar villain-avatar">
                    <img src="devilking.png" alt="ìˆ˜í•™ ë§ˆì™•" style="width: 100%; height: 100%; object-fit: cover;">
                    <img id="heroattack" src="heroattack.gif" alt="ìš©ì‚¬ íƒ€ê²© íš¨ê³¼" class="hero-attack-gif">
                    <img id="explosion" src="explosion.gif" alt="í­ë°œ íš¨ê³¼" class="hero-attack-gif">  <!-- ì¶”ê°€ -->
                    <img id="fullpower" src="fullpower.gif" alt="ê°•íƒ€ íš¨ê³¼" class="hero-attack-gif">  <!-- ì¶”ê°€ -->
                    <img id="meteor" src="meteo.gif" alt="ë©”í…Œì˜¤" class="hero-attack-gif">  <!-- ì¶”ê°€ -->
                    <img id="berserk" src="berserk.gif" alt="ë²„ì„œì»¤" class="hero-attack-gif">  <!-- ì¶”ê°€ -->
                    <img id="ultimate" src="ultimate.gif" alt="ê¶ê·¹ê¸°" class="hero-attack-gif">  <!-- ì¶”ê°€ -->





                </div>
            </div>
            <div class="character-right">
                <div class="stats">
                    <div class="stat-bar"><span class="stat-label">ì²´ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill hp-fill" id="villainHpBar">
                                80/80
                            </div>
                        </div>
                    </div>
                    <div class="stat-bar"><span class="stat-label">ê³µê²©ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill attack-fill" id="villainAttackBar">
                                12
                            </div>
                        </div>
                    </div>
                    <div class="stat-bar"><span class="stat-label">ë°©ì–´ë ¥</span>
                        <div class="stat-value">
                            <div class="stat-fill defense-fill" id="villainDefenseBar">
                                8
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   </div>

   <div class="math-section">
    <div class="math-problem" id="mathProblem">
         ë¬¸ì œ ë¡œë”© ì¤‘...
    </div>
    <div class="answer-section"><input type="number" step="0.001" class="answer-input" id="answerInput" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"> <button class="submit-btn" id="submitBtn">ì œì¶œ</button>
    </div>
    <div class="upgrade-section" id="upgradeSection">
     <h3 style="color: #744210; margin-bottom: 10px;">ì •ë‹µì…ë‹ˆë‹¤! ğŸ’°5ì½”ì¸ì„ ì–»ì—ˆìŠµë‹ˆë‹¤. ëŠ¥ë ¥ì¹˜ë¥¼ ì„ íƒí•˜ì—¬ ê°•í™”í•˜ì„¸ìš”:</h3>
     <div class="upgrade-buttons"><button class="upgrade-btn upgrade-hp" onclick="upgradePlayer('hp')">ì²´ë ¥ +20</button> <button class="upgrade-btn upgrade-attack" onclick="upgradePlayer('attack')">ê³µê²©ë ¥ +5</button> <button class="upgrade-btn upgrade-defense" onclick="upgradePlayer('defense')">ë°©ì–´ë ¥ +1</button> <button class="upgrade-btn upgrade-mana" onclick="upgradePlayer('mana')">ğŸ”® ìµœëŒ€ ë§ˆë‚˜ +5</button>
     </div>
    </div>
    <div class="skills-container">
        <!-- ìŠ¤í‚¬ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <div id="skillButtonsContainer" style="display: contents;"></div>
    </div>
    <div style="text-align: center; margin-top: 20px;"><button class="upgrade-btn" id="recoveryBtn" onclick="useRecovery()" style="background: linear-gradient(135deg, #9f7aea, #805ad5); font-size: 1.1rem; padding: 12px 25px;" disabled> ğŸ”® ë¦¬ì»¤ë²„ë¦¬ (ë§ˆë‚˜ 20) </button>
    </div>
   </div>
    
   <!-- ì˜¤ë¥¸ìª½: ì „íˆ¬ ë¡œê·¸ -->
   <div class="battle-log" id="battleLog">
    ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì†Œìˆ˜ ê³±ì…ˆ ë¬¸ì œë¥¼ í’€ì–´ì„œ ìºë¦­í„°ë¥¼ ê°•í™”í•˜ì„¸ìš”!<br>
   </div>
   
   </div>  <!-- ğŸ‘‡ game-content ë‹«ê¸° -->

   <!-- ìŠ¹ë¦¬ ëª¨ë‹¬ -->
    <div class="result-modal" id="victoryModal">
        <div class="result-content">
            <div class="victory">
                <h2 style="color: #22543d; margin-bottom: 15px;">ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ğŸ‰</h2>
                <p style="color: #2f855a;">ë¹ŒëŸ°ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! ë” ê°•í•œ ì ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.</p>
                <button class="next-level-btn" onclick="nextLevel()">ë‹¤ìŒ ë ˆë²¨ë¡œ</button>
            </div>
        </div>
    </div>

    <!-- íŒ¨ë°° ëª¨ë‹¬ -->
    <div class="result-modal" id="gameOverModal">
        <div class="result-content">
            <div class="game-over">
                <h2 style="color: #742a2a; margin-bottom: 15px;">ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤ ğŸ’€</h2>
                <p style="color: #c53030;">ë” ë§ì€ ë¬¸ì œë¥¼ í’€ì–´ì„œ ê°•í•´ì ¸ì•¼ í•©ë‹ˆë‹¤!</p>
                <button class="next-level-btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>
    </div>
  </div>

  <div class="shop-modal" id="shopModal" onclick="closeShopOnBackdrop(event)">
    <div class="shop-content" onclick="event.stopPropagation()">
        <button class="shop-close" onclick="closeShop()">Ã—</button>
        <h2 class="shop-title">ğŸª ê¸°ìˆ  ìƒì </h2>
        <div class="shop-coin-info">
            ë³´ìœ  ì½”ì¸: <span id="shopCoinAmount">0</span> ğŸ’°
        </div>
        <div class="skill-grid" id="skillShop"></div>
    </div>
  </div>

  <div class="ranking-modal" id="rankingModal" onclick="closeRankingOnBackdrop(event)">
    <div class="ranking-content" onclick="event.stopPropagation()">
        <button class="ranking-close" onclick="closeRanking()">Ã—</button>
        <h2 class="ranking-title">ğŸ† ê¸€ë¡œë²Œ ë­í‚¹</h2>
        <p class="ranking-subtitle">ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ê³¼ ê²½ìŸí•˜ì„¸ìš”! ë‹‰ë„¤ì„ì„ ì„¤ì •í• ë•ŒëŠ” ì´ë¦„ ë“± ê°œì¸ì •ë³´ë¥¼ ë„£ì§€ ë§ˆì„¸ìš”.</p>
        
        <!-- ì‚¬ìš©ì ì´ë¦„ ì„¤ì • -->
        <div class="username-section">
            <div>
                <input type="text" class="username-input" id="usernameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
                <button class="username-save-btn" onclick="saveUsername()">ë‹‰ë„¤ì„ ì €ì¥</button>
            </div>
            <div class="current-username" id="currentUsername">í˜„ì¬ ë‹‰ë„¤ì„: ìµëª…</div>
        </div>
        
        <!-- ë­í‚¹ íƒ­ -->
        <div class="ranking-tabs">
            <button class="ranking-tab active" onclick="switchRankingTab('level')">ìµœê³  ë ˆë²¨</button>
            <button class="ranking-tab" onclick="switchRankingTab('problems')">ìµœë‹¤ ë¬¸ì œ í•´ê²°</button>
            <button class="ranking-tab" onclick="switchRankingTab('damage')">ìµœëŒ€ í”¼í•´ëŸ‰</button>
        </div>

        <!-- ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€ -->
        <div id="myRankBox" style="display: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">ë‚´ ìˆœìœ„</div>
            <div style="font-size: 1.5rem; font-weight: bold;" id="myRankNumber">-</div>
            <div style="font-size: 1rem; margin-top: 5px;" id="myRankValue">-</div>
        </div>
        
        <!-- ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
        <div id="rankingList">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ìˆœìœ„</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th style="width: 120px;">ê¸°ë¡</th>
                    </tr>
                </thead>
                <tbody id="rankingTableBody">
                    <tr>
                        <td colspan="3" class="no-data">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ğŸ‘‡ ì—¬ê¸°ì— ì¹˜íŠ¸ ëª¨ë‹¬ HTML ì¶”ê°€ -->
<div class="cheat-modal" id="cheatModal" onclick="closeCheatOnBackdrop(event)">
    <div class="cheat-content" onclick="event.stopPropagation()">
        <button class="cheat-close" onclick="closeCheat()">Ã—</button>
        <h2 class="cheat-title">ğŸ® ì¹˜íŠ¸ ëª¨ë“œ</h2>
        <p style="color: #cbd5e0; margin-bottom: 20px;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="password" class="cheat-input" id="cheatInput" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="4">
        <br>
        <button class="cheat-btn" onclick="activateCheat()">í™œì„±í™”</button>
    </div>
</div>


  <audio id="hero-hit" src="quick-swing-sound-419581.mp3"></audio>
  <audio id="boss-hit" src="deadly-strike-352458.mp3"></audio>
  <audio id="upgrade-sound" src="bonus-points-190035.mp3"></audio>
  <audio id="healing-magic" src="healing-magic-4-378668.mp3"></audio>
  <audio id="game-over" src="game-over-417465.mp3"></audio>
  <audio id="fireball-sound" src="fireball-impact.mp3"></audio>
  <audio id="fullpower-sound" src="swordattack.mp3"></audio>
  <audio id="meteo-sound" src="meteo.mp3"></audio>
  <audio id="berserk-sound" src="berserk.mp3"></audio>
  <audio id="ultimate-sound" src="ultimate.mp3"></audio>
  <audio id="fire-break-sound" src="firebreaksound.mp3"></audio>






  <script>
        // localStorageë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ì €ì¥/ë¡œë“œ í•¨ìˆ˜
        const localStorageHelper = {
            save: function(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    console.log(`${key} ì €ì¥ ì™„ë£Œ:`, data);
                    return true;
                } catch (error) {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                    return false;
                }
            },
            
            load: function(key) {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        console.log(`${key} ë¡œë“œ ì™„ë£Œ`);
                        return JSON.parse(data);
                    }
                    return null;
                } catch (error) {
                    console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
                    return null;
                }
            },
            
            remove: function(key) {
                try {
                    localStorage.removeItem(key);
                    console.log(`${key} ì‚­ì œ ì™„ë£Œ`);
                    return true;
                } catch (error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    return false;
                }
            }
        };

        const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbzNpxvLzaKf6qz6k6KK-1AjaRwc-c5sJZDDLaCeLw5ag3UgZDqw1pLwsdiN_wBoXDJwAw/exec';

        // ğŸ”’ ë³´ì•ˆ í‚¤ (ì„œë²„ì™€ ë™ì¼í•´ì•¼ í•¨)
        // ì£¼ì˜: í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì— í‚¤ê°€ ë…¸ì¶œë˜ëŠ” ê²ƒì€ ì›¹ ê²Œì„ì˜ í•œê³„ì´ë‚˜, 
        // ìŠ¤í¬ë¦½íŠ¸ í‚¤ë”” ìˆ˜ì¤€ì˜ ë‹¨ìˆœ ì¡°ì‘ê³¼ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ë³€ì¡°ëŠ” íš¨ê³¼ì ìœ¼ë¡œ ë§‰ì•„ì¤ë‹ˆë‹¤.
        const SECRET_KEY = "math_hero_prevention_key_2024"; 

        // ê°„ë‹¨í•œ í•´ì‹œ ìƒì„± í•¨ìˆ˜ (ì„œë²„ì™€ ë¡œì§ ë™ì¼)
        function createSignature(username, level, problems, damage) {
            const rawString = username + "_" + level + "_" + problems + "_" + damage + "_" + SECRET_KEY;
            
            let hash = 0;
            if (rawString.length === 0) return hash.toString(16);
            for (let i = 0; i < rawString.length; i++) {
                const char = rawString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // ê²Œì„ ë³´ì•ˆ ìƒìˆ˜ (ì •ìƒì ì¸ ê³ ì¸ë¬¼ ìœ ì € ë³´í˜¸ë¥¼ ìœ„í•´ ì™„í™” ë° ì •êµí™”)
        const GAME_LIMITS = {
            // ì ˆëŒ€ì ì¸ ìƒí•œì„ ì€ ë§¤ìš° ë†’ê²Œ ì„¤ì • (ì´ë¡ ìƒ ë„ë‹¬ ê°€ëŠ¥í•œ í•œê³„)
            MAX_LEVEL: 100000,           // 10ë§Œ ë ˆë²¨ (ë­ì»¤ ê³ ë ¤)
            MAX_PROBLEMS_PER_DAY: 5000,  // í•˜ë£¨ 5000ë¬¸ì œ (ì´ˆì¸ì ì¸ í”Œë ˆì´ì–´ ê³ ë ¤)
            
            // ì†ë„ ê¸°ë°˜ ì œí•œ (ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œ ì†ë„ ì°¨ë‹¨)
            MIN_TIME_PER_PROBLEM: 500,   // ë¬¸ì œë‹¹ ìµœì†Œ 0.5ì´ˆ (ì¸ê°„ì˜ ë°˜ì‘ì†ë„ ê³ ë ¤)
            MAX_LEVEL_UP_SPEED: 10,      // 1ì´ˆë‹¹ ìµœëŒ€ ë ˆë²¨ì—… ìˆ˜ (ë¹„ì •ìƒ ê³ ì† ì„±ì¥ ë°©ì§€)
            
            // ë°ë¯¸ì§€ ê²€ì¦ìš©
            DAMAGE_TOLERANCE_MULTIPLIER: 5.0, // ë°ë¯¸ì§€ ì˜¤ì°¨ í—ˆìš© ë²”ìœ„ (ë²„í”„/í¬ë¦¬ ê³ ë ¤)
            
            // í”Œë ˆì´ íƒ€ì„ ê²€ì¦
            MIN_PLAY_TIME_RATIO: 0.1     // ë ˆë²¨ 1ë‹¹ ìµœì†Œ 0.1ì´ˆì˜ í”Œë ˆì´ íƒ€ì„ì€ ìˆì–´ì•¼ í•¨
        };

        // ê²Œì„ ìƒíƒœ
        let gameState = {
            level: 1,
            coins: 0, 
            ownedSkills: [], 
            username: 'ìµëª…',

            player: { hp: 100, maxHp: 100, attack: 15, defense: 10, mana: 0, maxMana: 20 },
            villain: { hp: 80, maxHp: 80, attack: 12, defense: 8 },
            currentProblem: { num1: 0.5, num2: 2, answer: 1.0 },
            battleInterval: null,
            manaInterval: null,
            gameActive: true,
            
            // ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ (ë§¤í¬ë¡œ ë°©ì§€ìš©)
            lastActionTime: Date.now(),
            lastProblemSolvedTime: 0,
            
            // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡
            currentStats: {
                problemsSolved: 0,
                totalDamage: 0,
                startTime: Date.now(),
                accumulatedPlayTime: 0, // ëˆ„ì  í”Œë ˆì´ ì‹œê°„ ì¶”ê°€
                dailyStats: {
                    date: new Date().toDateString(),
                    problemsSolved: 0,
                    totalDamage: 0,
                    playTime: 0
                }
            },
            // ìµœê³  ê¸°ë¡
            bestRecords: {
                level: 0,
                problemsSolved: 0,
                totalDamage: 0,
                maxHp: 0,
                maxAttack: 0,
                maxDefense: 0
            }
        };

        // ë°ì´í„° ê²€ì¦ í•¨ìˆ˜ë“¤ (ì •ìƒ í”Œë ˆì´ì–´ ë³´í˜¸ë¥¼ ìœ„í•´ ë¡œì§ ê°œì„ )
        const dataValidator = {
            // ë ˆë²¨ ê²€ì¦ (ì ˆëŒ€ê°’ë³´ë‹¤ëŠ” ì„±ì¥ ì†ë„ ìœ„ì£¼)
            validateLevel: function(level) {
                return Number.isInteger(level) && level >= 1 && level <= GAME_LIMITS.MAX_LEVEL;
            },

            // ë¬¸ì œ í•´ê²° ì†ë„ ê²€ì¦ (ë§¤í¬ë¡œ ë°©ì§€)
            validateSolveSpeed: function() {
                const now = Date.now();
                const timeDiff = now - gameState.lastProblemSolvedTime;
                
                // ì²« ë¬¸ì œê±°ë‚˜, ìµœì†Œ ì‹œê°„ë³´ë‹¤ ê¸¸ê²Œ ê±¸ë ¸ìœ¼ë©´ í†µê³¼
                if (gameState.lastProblemSolvedTime === 0 || timeDiff >= GAME_LIMITS.MIN_TIME_PER_PROBLEM) {
                    gameState.lastProblemSolvedTime = now;
                    return true;
                }
                
                return false; // ë„ˆë¬´ ë¹¨ë¦¬ í’€ì—ˆìŒ (ë§¤í¬ë¡œ ì˜ì‹¬)
            },

            // í”¼í•´ëŸ‰ ì •í•©ì„± ê²€ì¦ (ë ˆë²¨/ê³µê²©ë ¥ ëŒ€ë¹„ ë„ˆë¬´ í„°ë¬´ë‹ˆì—†ì§€ë§Œ ì•Šìœ¼ë©´ í—ˆìš©)
            validateDamage: function(damage, level, attack) {
                // ê¸°ë³¸ ê³µê²©ë ¥ + ìŠ¤í‚¬ ê³„ìˆ˜ ë“±ì„ ë„‰ë„‰í•˜ê²Œ ê³ ë ¤
                // ë ˆë²¨ì´ ë†’ìœ¼ë©´ ë°ë¯¸ì§€ë„ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ëŠ˜ì–´ë‚  ìˆ˜ ìˆìŒì„ ì¸ì •
                const maxReasonableDamage = (attack * 100) + (level * 10000); 
                
                return Number.isInteger(damage) &&
                       damage >= 0 &&
                       damage <= maxReasonableDamage * GAME_LIMITS.DAMAGE_TOLERANCE_MULTIPLIER;
            },

            // ë¬¸ì œ í•´ê²° ìˆ˜ ê²€ì¦ (ì¼ì¼ ì œí•œ) - ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬
            validateProblemsSolved: function(problems, dailyProblems) {
                return Number.isInteger(problems) &&
                       problems >= 0 &&
                       dailyProblems <= GAME_LIMITS.MAX_PROBLEMS_PER_DAY;
            },

            // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë°ì´í„° íŒ¨í„´ ê²€ì¶œ (ì‚­ì œ ëŒ€ì‹  ë§ˆí‚¹ìš©)
            detectSuspiciousPatterns: function(stats) {
                const { level, problemsSolved, totalDamage } = stats;

                // 1. ë ˆë²¨ ëŒ€ë¹„ ë¬¸ì œ ìˆ˜ê°€ ë„ˆë¬´ ì ìŒ (ì¹˜íŠ¸/í•µìœ¼ë¡œ ë ˆë²¨ë§Œ ì˜¬ë¦° ê²½ìš°)
                // ë‹¨, ì´ˆë°˜ êµ¬ê°„ì€ ì œì™¸í•˜ê³ , ë ˆë²¨ 100 ì´ìƒì¼ ë•Œ ë¬¸ì œë‹¹ ë ˆë²¨ì—… íš¨ìœ¨ì´ ë„ˆë¬´ ì¢‹ìœ¼ë©´ ì˜ì‹¬
                if (level > 100 && problemsSolved < level * 0.1) {
                    return true; 
                }

                // 2. ë¹„ì •ìƒì ì¸ ë°ë¯¸ì§€ ë¹„ìœ¨
                // ë¬¸ì œ í•´ê²° ìˆ˜ì— ë¹„í•´ ì´ ë°ë¯¸ì§€ê°€ ì²œë¬¸í•™ì ì¸ ê²½ìš°
                if (problemsSolved > 0 && totalDamage > (problemsSolved * level * 1000000)) {
                    return true;
                }

                return false;
            },

            // ì¼ì¼ í†µê³„ ì´ˆê¸°í™”
            resetDailyStatsIfNeeded: function() {
                const today = new Date().toDateString();
                if (gameState.currentStats.dailyStats.date !== today) {
                    gameState.currentStats.dailyStats = {
                        date: today,
                        problemsSolved: 0,
                        totalDamage: 0,
                        playTime: 0
                    };
                }
            }
        };
        
        // ğŸ”’ í•µì‹¬ ë¡œì§ ë™ê²° (ë³€ì¡° ë°©ì§€)
        Object.freeze(dataValidator);
        Object.freeze(GAME_LIMITS);
        /* //ìŠ¤í‚¬ */
        const SKILLS = {
            fireball: {
                id: 'fireball',
                name: 'ğŸ”¥ í™”ì—¼êµ¬',
                description: 'ê°•ë ¥í•œ í™”ì—¼êµ¬ë¥¼ ë°œì‚¬',
                icon: 'ğŸ”¥',
                cost: 50, // êµ¬ë§¤ ë¹„ìš© (ì½”ì¸)
                useCost: { type: 'mana', amount: 15 }, // ì‚¬ìš© ë¹„ìš©
                damage: 40
            },
            fullpower: {
                id: 'fullpower',
                name: 'ğŸ’ª í˜¼ì‹ ì˜ í˜',
                description: 'ê¸°ì˜ í˜ì„ ì‹¤ì€ ê³µê²©',
                icon: 'ğŸ’ª',
                cost: 70,
                useCost: { type: 'hp', amount: 18 },
                damage: 50
            },
            meteor: {
                id: 'meteor',
                name: 'â˜„ï¸ ë©”í…Œì˜¤',
                description: 'ê±°ëŒ€í•œ ìš´ì„ ë‚™í•˜',
                icon: 'â˜„ï¸',
                cost: 100,
                useCost: { type: 'mana', amount: 40 },
                damage: 100
            },
            berserk: {
                id: 'berserk',
                name: 'ğŸ’¥ ê´‘í­í™”',
                description: 'ì²´ë ¥ì„ ì†Œëª¨í•´ ê°•íƒ€',
                icon: 'ğŸ’¥',
                cost: 80,
                useCost: { type: 'hp', amount: 30 },
                damage: 80
            },
            ultimate: {
                id: 'ultimate',
                name: 'ğŸŒŸ ê¶ê·¹ê¸°',
                description: 'ìµœê°•ì˜ í•„ì‚´ê¸°!',
                icon: 'ğŸŒŸ',
                cost: 150,
                useCost: { type: 'both', hp: 20, mana: 30 },
                damage: 200
            }
        };

        // 5. loadBestRecords í•¨ìˆ˜ (ë°˜ë“œì‹œ ì—¬ê¸°!)
        function loadBestRecords() {
            const savedRecords = localStorageHelper.load('bestRecords');
            
            if (savedRecords) {
                gameState.bestRecords = savedRecords;
                console.log('ìµœê³  ê¸°ë¡ ë¡œë“œë¨:', gameState.bestRecords);
            } else {
                console.log('ì €ì¥ëœ ìµœê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                gameState.bestRecords = {
                    level: 0,
                    problemsSolved: 0,
                    totalDamage: 0,
                    maxHp: 0,
                    maxAttack: 0,
                    maxDefense: 0
                };
            }
        }



        // ë°ì´í„° ì €ì¥ì„ ìœ„í•œ ë³€ìˆ˜
        let allRecords = [];
        let dataInitialized = false;
        let gameLoaded = false;

        // ì†Œìˆ˜ ë°°ì—´ (100 ì´í•˜)
        const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97];

        // ì„¤ì • ê°ì²´
        const defaultConfig = {
            game_title: "Prime Battle Academy1.1",
            player_name: "ìš©ì‚¬",
            villain_name: "ìˆ˜í•™ ë§ˆì™•"
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ê²Œì„ ì´ˆê¸°í™” ì‹œì‘...');
            
            // ìµœê³  ê¸°ë¡ ë¡œë“œ
            loadBestRecords();
            
            // ê²Œì„ ì§„í–‰ ìƒí™© ë¡œë“œ
            loadGameProgress();

            // ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€
            // ì‚¬ìš©ì ì´ë¦„ ë¡œë“œ
            loadUsername();
            
            // Element SDK ì´ˆê¸°í™” (ìˆìœ¼ë©´)
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
                        document.getElementById('playerName').textContent = config.player_name || defaultConfig.player_name;
                        const baseVillainName = config.villain_name || defaultConfig.villain_name;
                        document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["game_title", config.game_title || defaultConfig.game_title],
                        ["player_name", config.player_name || defaultConfig.player_name],
                        ["villain_name", config.villain_name || defaultConfig.villain_name]
                    ])
                });
            }
            
            console.log('ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ');
        });
        
        // ê²Œì„ ì´ˆê¸°í™” (ë§¨ ë§ˆì§€ë§‰!)
        updateDisplay();
        updateRecordsDisplay();
        renderSkillButtons();
        
        setTimeout(() => {
            if (!gameLoaded) {
                generateProblem();
                startBattle();
                startManaRegeneration();
            } else {
                generateProblem();
                startBattle();
                startManaRegeneration();
            }
        }, 500);
        
        setInterval(updateRecordsDisplay, 1000);

        /* // Data SDK ì´ˆê¸°í™”
        // ìˆ˜ì • ì½”ë“œ
        const dataHandler = {
            onDataChanged(data) {
                console.log('ë°ì´í„° ë³€ê²½ë¨:', data.length, 'ê°œì˜ ë ˆì½”ë“œ'); // ë””ë²„ê¹…ìš©
                allRecords = data;
                if (!dataInitialized) {
                    loadBestRecords(); // ìµœê³  ê¸°ë¡ ë¨¼ì € ë¡œë“œ
                    loadGameProgress(); // ê²Œì„ ì§„í–‰ ìƒí™© ë¡œë“œ
                    dataInitialized = true;
                    updateRecordsDisplay(); // í™”ë©´ ì—…ë°ì´íŠ¸
                }
            }
        }; */


        /* // SDK ì´ˆê¸°í™”
        async function initializeSDKs() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Data SDK ì´ˆê¸°í™” ì‹¤íŒ¨");
                }
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
                        document.getElementById('playerName').textContent = config.player_name || defaultConfig.player_name;
                        const baseVillainName = config.villain_name || defaultConfig.villain_name;
                        document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
                    },
                        /* document.getElementById('villainName').textContent = config.villain_name || defaultConfig.villain_name;
                    }, */
                    /* mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["game_title", config.game_title || defaultConfig.game_title],
                        ["player_name", config.player_name || defaultConfig.player_name],
                        ["villain_name", config.villain_name || defaultConfig.villain_name]
                    ])
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ SDK ì´ˆê¸°í™”
        initializeSDKs(); */ 

        // ê²Œì„ ì§„í–‰ ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸° (ê²€ì¦ ì™„í™”: ì •ìƒ ë°ì´í„° ì‚­ì œ ë°©ì§€)
        function loadGameProgress() {
            const savedProgress = localStorageHelper.load('gameProgress');

            if (savedProgress && savedProgress.game_active) {
                // ë°ì´í„° ì •í•©ì„± ì²´í¬ (ì‚­ì œ ëŒ€ì‹  ê°’ ë³´ì •)
                gameState.level = Math.min(savedProgress.level, GAME_LIMITS.MAX_LEVEL);
                
                // ì½”ì¸ì´ë‚˜ ìŠ¤í‚¬ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ë§ì•„ë„ ì¼ë‹¨ ë¡œë“œí•˜ë˜, ìµœëŒ€ì¹˜ë¡œ ìº¡ì„ ì”Œì›€
                gameState.coins = Math.min(savedProgress.coins || 0, 999999999); 
                gameState.ownedSkills = savedProgress.owned_skills || [];

                // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ë³´ì • ë¡œë“œ
                gameState.player = {
                    hp: Math.min(savedProgress.player_hp, savedProgress.player_max_hp),
                    maxHp: Math.min(savedProgress.player_max_hp, 1000000), // ë°±ë§Œ ì²´ë ¥ê¹Œì§€ í—ˆìš©
                    attack: Math.min(savedProgress.player_attack, 500000), // 50ë§Œ ê³µê²©ë ¥ê¹Œì§€ í—ˆìš©
                    defense: Math.min(savedProgress.player_defense, 200000), 
                    mana: Math.min(savedProgress.player_mana, savedProgress.player_max_mana || 20),
                    maxMana: Math.min(savedProgress.player_max_mana || 20, 10000) 
                };

                const levelMultiplier = 1 + (gameState.level - 1) * 0.3;
                gameState.villain = {
                    hp: savedProgress.villain_hp || Math.floor(80 * levelMultiplier), // ì €ì¥ëœ ì²´ë ¥ ìš°ì„  ì‚¬ìš©
                    maxHp: savedProgress.villain_max_hp || Math.floor(80 * levelMultiplier),
                    attack: Math.floor(12 * levelMultiplier),
                    defense: Math.floor(8 * levelMultiplier)
                };

                // í˜„ì¬ ê¸°ë¡ ë³µì›
                gameState.currentStats.problemsSolved = savedProgress.problems_solved || 0;
                gameState.currentStats.totalDamage = savedProgress.total_damage || 0;
                gameState.currentStats.accumulatedPlayTime = savedProgress.play_time || 0; // ëˆ„ì  ì‹œê°„ ë³µì›
                gameState.currentStats.startTime = Date.now(); // í˜„ì¬ ì„¸ì…˜ ì‹œì‘ ì‹œê°„ ì¬ì„¤ì •

                // ì¼ì¼ í†µê³„ ë³µì›
                if (savedProgress.daily_stats) {
                    gameState.currentStats.dailyStats = savedProgress.daily_stats;
                    dataValidator.resetDailyStatsIfNeeded(); 
                }

                // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë°ì´í„° í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ê²½ê³ ë§Œ í‘œì‹œ (ê²Œì„ì€ ê°€ëŠ¥í•˜ê²Œ)
                if (savedProgress.suspicious) {
                    addBattleLog('âš ï¸ ë°ì´í„° ê²€ì¦ ê²½ê³ : ì¼ë¶€ ê¸°ë¡ì´ ë¹„ì •ìƒì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }

                gameState.gameActive = true;
                gameLoaded = true;

                addBattleLog(`ì´ì „ ê²Œì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ë ˆë²¨ ${gameState.level}ë¶€í„° ê³„ì†í•©ë‹ˆë‹¤.`);
                updateDisplay();
                renderSkillButtons();
            }
        }

        // ê²Œì„ ì§„í–‰ ìƒí™© ì €ì¥ (ê²€ì¦ í¬í•¨)
        async function saveGameProgress() {
            // ì¼ì¼ í†µê³„ ì´ˆê¸°í™” í™•ì¸
            dataValidator.resetDailyStatsIfNeeded();

            // í˜„ì¬ê¹Œì§€ì˜ í”Œë ˆì´ ì‹œê°„ ê³„ì‚° (ëˆ„ì  ì‹œê°„ + í˜„ì¬ ì„¸ì…˜ ì‹œê°„)
            const currentSessionTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            const totalPlayTime = (gameState.currentStats.accumulatedPlayTime || 0) + currentSessionTime;

            // ì €ì¥í•  ë°ì´í„° ê²€ì¦
            const progressData = {
                record_type: 'game_progress',
                level: gameState.level,
                coins: gameState.coins,
                owned_skills: gameState.ownedSkills,
                problems_solved: gameState.currentStats.problemsSolved,
                total_damage: gameState.currentStats.totalDamage,
                play_time: totalPlayTime, // ì´ í”Œë ˆì´ ì‹œê°„ ì €ì¥
                player_hp: gameState.player.hp,
                player_max_hp: gameState.player.maxHp,
                player_attack: gameState.player.attack,
                player_defense: gameState.player.defense,
                player_mana: gameState.player.mana,
                player_max_mana: gameState.player.maxMana,
                villain_hp: gameState.villain.hp, // í˜„ì¬ ë¹ŒëŸ° ì²´ë ¥ ì €ì¥
                villain_max_hp: gameState.villain.maxHp, // ë¹ŒëŸ° ìµœëŒ€ ì²´ë ¥ ì €ì¥
                villain_attack: gameState.villain.attack,
                villain_defense: gameState.villain.defense,
                game_active: gameState.gameActive,
                timestamp: new Date().toISOString(),
                daily_stats: gameState.currentStats.dailyStats
            };

            // ë°ì´í„° ê²€ì¦ (ë‹¨ìˆœ ì˜¤ë¥˜ ì²´í¬ë§Œ)
            if (!Number.isInteger(progressData.level) || progressData.level < 1) {
                console.warn('ë¹„ì •ìƒì ì¸ ê²Œì„ ë°ì´í„° ê°ì§€ë¨ - ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤');
                return;
            }

            // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ ê²€ì¶œ
            if (dataValidator.detectSuspiciousPatterns({
                level: progressData.level,
                problemsSolved: progressData.problems_solved,
                totalDamage: progressData.total_damage
            })) {
                console.warn('ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ê²Œì„ íŒ¨í„´ ê°ì§€ë¨ - ì €ì¥ì„ ì œí•œí•©ë‹ˆë‹¤');
                // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë°ì´í„°ëŠ” ì €ì¥í•˜ë˜ í”Œë˜ê·¸ ì¶”ê°€
                progressData.suspicious = true;
            }

            localStorageHelper.save('gameProgress', progressData);
        }

        /* async function saveGameProgress() {
            if (!window.dataSdk) return;
            
            // ê¸°ì¡´ ì§„í–‰ ìƒí™© ë ˆì½”ë“œ ì‚­ì œ
            const progressRecords = allRecords.filter(record => record.record_type === 'game_progress');
            for (const record of progressRecords) {
                await window.dataSdk.delete(record);
            }
            
            // ìƒˆë¡œìš´ ì§„í–‰ ìƒí™© ì €ì¥
            const progressData = {
                record_type: 'game_progress',
                level: gameState.level,
                coins: gameState.coins, // ì¶”ê°€
                owned_skills: gameState.ownedSkills, // ì¶”ê°€
                problems_solved: gameState.currentStats.problemsSolved,
                total_damage: gameState.currentStats.totalDamage,
                max_hp: 0,
                max_attack: 0,
                max_defense: 0,
                play_time: 0,
                player_hp: gameState.player.hp,
                player_max_hp: gameState.player.maxHp,
                player_attack: gameState.player.attack,
                player_defense: gameState.player.defense,
                player_mana: gameState.player.mana,
                villain_hp: gameState.villain.hp,
                villain_max_hp: gameState.villain.maxHp,
                villain_attack: gameState.villain.attack,
                villain_defense: gameState.villain.defense,
                game_active: gameState.gameActive,
                timestamp: new Date().toISOString()
            };
            
            await window.dataSdk.create(progressData);
        }

        // ê¸°ë¡ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function loadBestRecords() {
            const savedRecords = localStorageHelper.load('bestRecords');
            
            if (savedRecords) {
                gameState.bestRecords = savedRecords;
                console.log('ìµœê³  ê¸°ë¡ ë¡œë“œë¨:', gameState.bestRecords);
            } else {
                console.log('ì €ì¥ëœ ìµœê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                // ì´ˆê¸°ê°’ ì„¤ì •
                gameState.bestRecords = {
                    level: 0,
                    problemsSolved: 0,
                    totalDamage: 0,
                    maxHp: 0,
                    maxAttack: 0,
                    maxDefense: 0
                };
            }
        } */

        /* function loadBestRecords() {
            const records = allRecords.filter(record => record.record_type === 'best_record');
            if (records.length > 0) {
                const bestRecord = records[0];
                gameState.bestRecords = {
                    level: bestRecord.level || 0,
                    problemsSolved: bestRecord.problems_solved || 0,
                    totalDamage: bestRecord.total_damage || 0,
                    maxHp: bestRecord.max_hp || 0,
                    maxAttack: bestRecord.max_attack || 0,
                    maxDefense: bestRecord.max_defense || 0
                };
            }
        } */

        // ìµœê³  ê¸°ë¡ ê²€ì¦ ë° ì €ì¥ (ì´ˆê¸°í™” ëŒ€ì‹  ë­í‚¹ ë“±ë¡ ì œì™¸)
        async function saveBestRecords() {
            // ì¼ì¼ í†µê³„ ì´ˆê¸°í™” í™•ì¸
            dataValidator.resetDailyStatsIfNeeded();

            // í˜„ì¬ ê¸°ë¡ ê²€ì¦
            const currentRecords = {
                level: gameState.level,
                problemsSolved: gameState.currentStats.problemsSolved,
                totalDamage: gameState.currentStats.totalDamage
            };

            // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ ê²€ì¶œ ì‹œ ì €ì¥í•˜ë˜ ê²½ê³  ë¡œê·¸ë§Œ ë‚¨ê¹€ (ë¡œì»¬ í”Œë ˆì´ í—ˆìš©)
            if (dataValidator.detectSuspiciousPatterns(currentRecords)) {
                console.warn('ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ê¸°ë¡ íŒ¨í„´ ê°ì§€ë¨ - ë­í‚¹ ì—…ë¡œë“œë§Œ ì œí•œë©ë‹ˆë‹¤');
                // ë¡œì»¬ ì €ì¥ì€ í—ˆìš©í•˜ë˜ ë­í‚¹ ì—…ë¡œë“œëŠ” í•˜ì§€ ì•ŠìŒ
                localStorageHelper.save('bestRecords', gameState.bestRecords);
                return;
            }

            // ê° ê¸°ë¡ë³„ ê²€ì¦ ë° ì—…ë°ì´íŠ¸
            let hasNewRecord = false;

            if (dataValidator.validateLevel(gameState.level) &&
                gameState.level > gameState.bestRecords.level) {
                gameState.bestRecords.level = gameState.level;
                hasNewRecord = true;
            }

            // ... (ì¤‘ëµ) ...

            if (gameState.currentStats.problemsSolved > gameState.bestRecords.problemsSolved) {
                gameState.bestRecords.problemsSolved = gameState.currentStats.problemsSolved;
                hasNewRecord = true;
            }

            if (dataValidator.validateDamage(
                    gameState.currentStats.totalDamage,
                    gameState.level,
                    gameState.player.attack) &&
                gameState.currentStats.totalDamage > gameState.bestRecords.totalDamage) {
                gameState.bestRecords.totalDamage = gameState.currentStats.totalDamage;
                hasNewRecord = true;
            }

            // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ê¸°ë¡ë„ ê²€ì¦
            const playerStats = gameState.player;
            if (playerStats.maxHp > gameState.bestRecords.maxHp) {
                gameState.bestRecords.maxHp = playerStats.maxHp;
            }
            if (playerStats.attack > gameState.bestRecords.maxAttack) {
                gameState.bestRecords.maxAttack = playerStats.attack;
            }
            if (playerStats.defense > gameState.bestRecords.maxDefense) {
                gameState.bestRecords.maxDefense = playerStats.defense;
            }

            if (hasNewRecord) {
                const success = localStorageHelper.save('bestRecords', gameState.bestRecords);

                if (success) {
                    console.log('ìµœê³  ê¸°ë¡ ì €ì¥ë¨:', gameState.bestRecords);
                    await uploadToRanking();
                } else {
                    console.error('ìµœê³  ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨');
                }
            }
        }

        // resetBestRecords í•¨ìˆ˜ - localStorage ì‚¬ìš©
        async function resetBestRecords() {
            if (!confirm('ì •ë§ ìµœê³  ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // localStorageì—ì„œ ì‚­ì œ
            localStorageHelper.remove('bestRecords');
            
            // ë©”ëª¨ë¦¬ì—ì„œë„ ì´ˆê¸°í™”
            gameState.bestRecords = {
                level: 0,
                problemsSolved: 0,
                totalDamage: 0,
                maxHp: 0,
                maxAttack: 0,
                maxDefense: 0
            };
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            updateRecordsDisplay();
            addBattleLog('âœ¨ ìµœê³  ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            alert('ìµœê³  ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            console.log('ìµœê³  ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        async function saveGameSession() {
            if (!window.dataSdk) return;

            const playTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            
            const sessionData = {
                record_type: 'game_session',
                level: gameState.level,
                problems_solved: gameState.currentStats.problemsSolved,
                total_damage: gameState.currentStats.totalDamage,
                max_hp: gameState.player.maxHp,
                max_attack: gameState.player.attack,
                max_defense: gameState.player.defense,
                play_time: playTime,
                player_hp: 0,
                player_max_hp: 0,
                player_attack: 0,
                player_defense: 0,
                player_mana: 0,
                villain_hp: 0,
                villain_max_hp: 0,
                villain_attack: 0,
                villain_defense: 0,
                game_active: false,
                timestamp: new Date().toISOString()
            };

            await window.dataSdk.create(sessionData);
        }

        function updateBestRecords() {
            let newRecord = false;
            
            if (gameState.level > gameState.bestRecords.level) {
                gameState.bestRecords.level = gameState.level;
                highlightNewRecord('bestLevel');
                newRecord = true;
            }
            
            if (gameState.currentStats.problemsSolved > gameState.bestRecords.problemsSolved) {
                gameState.bestRecords.problemsSolved = gameState.currentStats.problemsSolved;
                highlightNewRecord('bestProblems');
                newRecord = true;
            }
            
            if (gameState.currentStats.totalDamage > gameState.bestRecords.totalDamage) {
                gameState.bestRecords.totalDamage = gameState.currentStats.totalDamage;
                highlightNewRecord('bestDamage');
                newRecord = true;
            }
            
            if (gameState.player.maxHp > gameState.bestRecords.maxHp) {
                gameState.bestRecords.maxHp = gameState.player.maxHp;
                highlightNewRecord('bestHp');
                newRecord = true;
            }
            
            if (gameState.player.attack > gameState.bestRecords.maxAttack) {
                gameState.bestRecords.maxAttack = gameState.player.attack;
                highlightNewRecord('bestAttack');
                newRecord = true;
            }
            
            if (gameState.player.defense > gameState.bestRecords.maxDefense) {
                gameState.bestRecords.maxDefense = gameState.player.defense;
                newRecord = true;
            }
            
            if (newRecord) {
                console.log('ìƒˆ ìµœê³  ê¸°ë¡ ë‹¬ì„±, ì €ì¥ ì‹œì‘...'); // ë””ë²„ê¹…ìš©
                saveBestRecords();
                addBattleLog('ğŸ‰ ìƒˆë¡œìš´ ìµœê³  ê¸°ë¡ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!');
            }
        }

        function highlightNewRecord(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.parentElement) {
                element.parentElement.classList.add('new-record');
                setTimeout(() => {
                    element.parentElement.classList.remove('new-record');
                }, 2000);
            }
        }

        function updateRecordsDisplay() {
            // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡ ì—…ë°ì´íŠ¸
            document.getElementById('currentLevel').textContent = gameState.level;
            document.getElementById('problemsSolved').textContent = gameState.currentStats.problemsSolved;
            document.getElementById('totalDamage').textContent = gameState.currentStats.totalDamage;
            
            const currentSessionTime = Math.floor((Date.now() - gameState.currentStats.startTime) / 1000);
            const totalPlayTime = (gameState.currentStats.accumulatedPlayTime || 0) + currentSessionTime;
            
            const minutes = Math.floor(totalPlayTime / 60);
            const seconds = totalPlayTime % 60;
            document.getElementById('playTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // ìµœê³  ê¸°ë¡ ì—…ë°ì´íŠ¸
            document.getElementById('bestLevel').textContent = gameState.bestRecords.level || '-';
            document.getElementById('bestProblems').textContent = gameState.bestRecords.problemsSolved || '-';
            document.getElementById('bestDamage').textContent = gameState.bestRecords.totalDamage || '-';
            document.getElementById('bestHp').textContent = gameState.bestRecords.maxHp || '-';
            document.getElementById('bestAttack').textContent = gameState.bestRecords.maxAttack || '-';
        }

        // ìƒˆë¡œìš´ ì†Œìˆ˜ ê³±ì…ˆ ë¬¸ì œ ìƒì„±
        function generateProblem() {
            // ìì—°ìˆ˜ ë°°ì—´ (1-20)
            const naturalNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
            
            // í•œìë¦¬ ì†Œìˆ˜ (0.1 ~ 0.9)
            const oneDigitDecimals = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];
            
            // ë‘ìë¦¬ ì†Œìˆ˜ (0.10 ~ 0.99, 0.05 ê°„ê²©)
            const twoDigitDecimals = [];
            for (let i = 10; i <= 99; i += 5) {
                twoDigitDecimals.push(i / 100);
            }
            
            // ë¬¸ì œ ìœ í˜• ì„ íƒ (1: ìì—°ìˆ˜Ã—ì†Œìˆ˜, 2: ì†Œìˆ˜Ã—ìì—°ìˆ˜, 3: ì†Œìˆ˜Ã—ì†Œìˆ˜)
            const problemType = Math.floor(Math.random() * 3) + 1;
            let num1, num2, answer;
            
            if (problemType === 1) {
                // ìì—°ìˆ˜ Ã— ì†Œìˆ˜ (í•œìë¦¬ ë˜ëŠ” ë‘ìë¦¬)
                num1 = naturalNumbers[Math.floor(Math.random() * naturalNumbers.length)];
                const useOneDigit = Math.random() < 0.5;
                if (useOneDigit) {
                    num2 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                } else {
                    num2 = twoDigitDecimals[Math.floor(Math.random() * twoDigitDecimals.length)];
                }
            } else if (problemType === 2) {
                // ì†Œìˆ˜ Ã— ìì—°ìˆ˜
                const useOneDigit = Math.random() < 0.5;
                if (useOneDigit) {
                    num1 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                } else {
                    num1 = twoDigitDecimals[Math.floor(Math.random() * twoDigitDecimals.length)];
                }
                num2 = naturalNumbers[Math.floor(Math.random() * naturalNumbers.length)];
            } else {
                // ì†Œìˆ˜ Ã— ì†Œìˆ˜ (ë‘˜ ë‹¤ í•œìë¦¬)
                num1 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
                num2 = oneDigitDecimals[Math.floor(Math.random() * oneDigitDecimals.length)];
            }
            
            answer = Math.round((num1 * num2) * 1000) / 1000; // ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
            
            gameState.currentProblem = { num1, num2, answer };
            document.getElementById('mathProblem').textContent = `${num1} Ã— ${num2} = ?`;
            document.getElementById('answerInput').value = '';
            document.getElementById('upgradeSection').style.display = 'none';
        }

        // ë‹µì•ˆ í™•ì¸ (ë§¤í¬ë¡œ ë°©ì§€ ì¶”ê°€)
        function checkAnswer() {
            // ë§¤í¬ë¡œ ë°©ì§€: ë„ˆë¬´ ë¹ ë¥¸ ë¬¸ì œ í’€ì´ ì°¨ë‹¨
            if (!dataValidator.validateSolveSpeed()) {
                addBattleLog('âš ï¸ ë„ˆë¬´ ë¹¨ë¦¬ ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤! (ë§¤í¬ë¡œ ê°ì§€)');
                return;
            }

            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const correctAnswer = gameState.currentProblem.answer;

            // ì†Œìˆ˜ì  ê³„ì‚°ì˜ ì˜¤ì°¨ë¥¼ ê³ ë ¤í•˜ì—¬ 0.001 ë²”ìœ„ ë‚´ì—ì„œ ì •ë‹µ ì²˜ë¦¬
            if (Math.abs(userAnswer - correctAnswer) < 0.001) {
                // ì¼ì¼ í†µê³„ ì´ˆê¸°í™” í™•ì¸
                dataValidator.resetDailyStatsIfNeeded();

                // ì¼ì¼ ë¬¸ì œ í•´ê²° ìˆ˜ ì œí•œ í™•ì¸ (í•˜ë£¨ì¢…ì¼ í”Œë ˆì´í•˜ëŠ” ìœ ì € ë°°ë ¤í•˜ì—¬ ìƒí•œ ëŒ€í­ ìƒí–¥)
                if (gameState.currentStats.dailyStats.problemsSolved >= GAME_LIMITS.MAX_PROBLEMS_PER_DAY) {
                    addBattleLog(`âš ï¸ ì˜¤ëŠ˜ì˜ ë¬¸ì œ í•´ê²° í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!`);
                    document.getElementById('answerInput').value = '';
                    return;
                }

                const coinsEarned = 5;
                gameState.coins += coinsEarned;
                addBattleLog(`ì •ë‹µì…ë‹ˆë‹¤! ${gameState.currentProblem.num1} Ã— ${gameState.currentProblem.num2} = ${correctAnswer}`);
                gameState.currentStats.problemsSolved++;
                gameState.currentStats.dailyStats.problemsSolved++;
                updateBestRecords();
                updateRecordsDisplay();
                document.getElementById('upgradeSection').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
            } else {
                addBattleLog(`í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”!`);
                document.getElementById('answerInput').value = '';
            }
        }

        // í”Œë ˆì´ì–´ ê°•í™”
        function upgradePlayer(stat) {
            switch(stat) {
                case 'hp':
                    gameState.player.maxHp += 20;
                    gameState.player.hp += 20;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ì²´ë ¥ì´ 20 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
                case 'attack':
                    gameState.player.attack += 5;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ê³µê²©ë ¥ì´ 5 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
                case 'defense':
                    gameState.player.defense += 1;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ë°©ì–´ë ¥ì´ 1 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound()
                    break;
                // ğŸ‘‡ ì´ ë¶€ë¶„ ì¶”ê°€!
                case 'mana':
                    gameState.player.maxMana += 5;
                    gameState.player.mana += 5;  // ìµœëŒ€ ë§ˆë‚˜ ì¦ê°€ì™€ í•¨ê»˜ í˜„ì¬ ë§ˆë‚˜ë„ 5 ì¦ê°€
                    addBattleLog(`${document.getElementById('playerName').textContent}ì˜ ìµœëŒ€ ë§ˆë‚˜ê°€ 5 ì¦ê°€í–ˆìŠµë‹ˆë‹¤!`);
                    playupgradeSound();
                    break;    
            }
            
            updateDisplay();
            saveGameProgress();
            generateProblem();
            document.getElementById('submitBtn').disabled = false;
        }

        // ë§ˆë‚˜ íšŒë³µ ì‹œìŠ¤í…œ
        function startManaRegeneration() {
            if (gameState.manaInterval) {
                clearInterval(gameState.manaInterval);
            }
            
            gameState.manaInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                if (gameState.player.mana < gameState.player.maxMana) {
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + 1);
                    updateDisplay();
                }
            }, 2000); // 2ì´ˆë§ˆë‹¤ ë§ˆë‚˜ 1ì”© íšŒë³µ
        }

        // ë¦¬ì»¤ë²„ë¦¬ ë§ˆë²• ì‚¬ìš©
        function useRecovery() {
            if (gameState.player.mana >= 20) {
                gameState.player.mana -= 20;
                gameState.player.hp = gameState.player.maxHp;
                addBattleLog(`ğŸ”® ë¦¬ì»¤ë²„ë¦¬ ë§ˆë²•ìœ¼ë¡œ ì²´ë ¥ì„ ì™„ì „ íšŒë³µí–ˆìŠµë‹ˆë‹¤!`);
                playhealingSound()
                updateDisplay();
                saveGameProgress();

            }
        }

        // ì „íˆ¬ ì‹œìŠ¤í…œ
        function startBattle() {
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
            }
            
            gameState.battleInterval = setInterval(() => {
                if (!gameState.gameActive) return;

                // í”Œë ˆì´ì–´ ê³µê²©
                const playerDamage = Math.max(1, gameState.player.attack - gameState.villain.defense);

                // í”¼í•´ëŸ‰ ì¼ì¼ ì œí•œ í™•ì¸
                const newTotalDamage = gameState.currentStats.totalDamage + playerDamage;
                if (newTotalDamage > gameState.level * GAME_LIMITS.MAX_DAMAGE_PER_LEVEL) {
                    // ì œí•œ ì´ˆê³¼ì‹œ í”¼í•´ëŸ‰ ì¡°ì •
                    const adjustedDamage = Math.max(1, (gameState.level * GAME_LIMITS.MAX_DAMAGE_PER_LEVEL) - gameState.currentStats.totalDamage);
                    gameState.villain.hp = Math.max(0, gameState.villain.hp - adjustedDamage);
                    gameState.currentStats.totalDamage += adjustedDamage;
                    gameState.currentStats.dailyStats.totalDamage += adjustedDamage;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì´(ê°€) ${adjustedDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤! (ì¼ì¼ ì œí•œ ì ìš©)`);
                } else {
                    gameState.villain.hp = Math.max(0, gameState.villain.hp - playerDamage);
                    gameState.currentStats.totalDamage += playerDamage;
                    gameState.currentStats.dailyStats.totalDamage += playerDamage;
                    addBattleLog(`${document.getElementById('playerName').textContent}ì´(ê°€) ${playerDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                }

                updateRecordsDisplay();
                playHeroAttackSound();
                triggerHitEffect('heroattack');

                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
                
                // ë¹ŒëŸ° ê³µê²©
                setTimeout(() => {
                    if (!gameState.gameActive) return;
                    
                    // ë ˆë²¨ë³„ ê´€í†µ í™•ë¥  í•¨ìˆ˜
                    const getPenetrationChance = (level) => {
                        if (level <= 3) return 0.2;
                        if (level <= 6) return 0.3;
                        if (level <= 9) return 0.4;
                        return 0.5;
                    };
                    
                    const penetrationChance = getPenetrationChance(gameState.level);
                    const isPenetrationActive = Math.random() < penetrationChance;
                    
                    let villainDamage;
                    
                    if (isPenetrationActive) {
                        // ë¶€ë¶„ ê´€í†µ ë°œë™
                        const armorPenetration = Math.min(0.5, gameState.level * 0.04);
                        const effectiveDefense = Math.floor(gameState.player.defense * (1 - armorPenetration));
                        villainDamage = Math.max(2, gameState.villain.attack - effectiveDefense);
                        playfirebreakSound();  // ë¶ˆê½ƒ ê³µê²© ì „ìš© íš¨ê³¼ìŒ
                        triggerHitEffect('firebreak');  // ë¶ˆê½ƒ ê³µê²©
                        
                        const penetrationPercent = Math.round(armorPenetration * 100);
                        addBattleLog(`âš¡ ${document.getElementById('villainName').textContent}ì˜ ë¶ˆê½ƒ ê³µê²©(ë°©ì–´ ì¼ë¶€ ë¬´ì‹œ)! (ë°©ì–´ë ¥ ${penetrationPercent}% ë¬´ì‹œ) ${villainDamage}ì˜ í”¼í•´!`);
                    } else {
                        // ì¼ë°˜ ê³µê²©
                        villainDamage = Math.max(1, gameState.villain.attack - gameState.player.defense);
                        addBattleLog(`${document.getElementById('villainName').textContent}ì´(ê°€) ${villainDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                    }
                    
                    gameState.player.hp = Math.max(0, gameState.player.hp - villainDamage);
                    playBossAttackSound(); 
                    triggerHitEffect('devilattack'); 
                    
                    if (gameState.player.hp <= 0) {
                        gameOver();
                        return;
                    }
                    
                    updateDisplay();
                    saveGameProgress();
                }, 1500);
                
                updateDisplay();
                saveGameProgress();
            }, 3000);
        }
        /* // ì „íˆ¬ ì‹œìŠ¤í…œ
        function startBattle() {
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
            }
            
            gameState.battleInterval = setInterval(() => {
                if (!gameState.gameActive) return;
                
                // í”Œë ˆì´ì–´ ê³µê²©
                const playerDamage = Math.max(1, gameState.player.attack - gameState.villain.defense);
                gameState.villain.hp = Math.max(0, gameState.villain.hp - playerDamage);
                gameState.currentStats.totalDamage += playerDamage;
                updateRecordsDisplay();
                addBattleLog(`${document.getElementById('playerName').textContent}ì´(ê°€) ${playerDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                playHeroAttackSound(); // âœ¨ ì—¬ê¸°ì— ìš©ì‚¬ ê³µê²© ì†Œë¦¬ ì¶”ê°€!
                triggerHitEffect('devil-attack-gif'); // âœ¨ [ì¶”ê°€] ë§ˆì™•ì—ê²Œ íƒ€ê²© íš¨ê³¼ ì¶œë ¥

                if (gameState.villain.hp <= 0) {
                    victory();
                    return;
                }
                
                // ë¹ŒëŸ° ê³µê²©
                setTimeout(() => {
                    if (!gameState.gameActive) return;
                    
                    const villainDamage = Math.max(1, gameState.villain.attack - gameState.player.defense);
                    gameState.player.hp = Math.max(0, gameState.player.hp - villainDamage);
                    addBattleLog(`${document.getElementById('villainName').textContent}ì´(ê°€) ${villainDamage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!`);
                    playBossAttackSound(); // âœ¨ ì—¬ê¸°ì— ë§ˆì™• ê³µê²© ì†Œë¦¬ ì¶”ê°€!
                    triggerHitEffect('hero-attack-gif'); // âœ¨ [ì¶”ê°€] ìš©ì‚¬ì—ê²Œ íƒ€ê²© íš¨ê³¼ ì¶œë ¥
                    if (gameState.player.hp <= 0) {
                        gameOver();
                        return;
                    }
                    
                    updateDisplay();
                    saveGameProgress();
                }, 1500);
                
                updateDisplay();
                saveGameProgress();
            }, 3000);
        } */

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateDisplay() {

            // ì½”ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ì¶”ê°€
            document.getElementById('coinAmount').textContent = gameState.coins;
            document.getElementById('shopCoinAmount').textContent = gameState.coins;
            // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('playerHpBar').style.width = `${playerHpPercent}%`;
            document.getElementById('playerHpBar').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('playerAttackBar').textContent = gameState.player.attack;
            document.getElementById('playerDefenseBar').textContent = gameState.player.defense;
            
            // ë§ˆë‚˜ ë°” ì—…ë°ì´íŠ¸
            const playerManaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            document.getElementById('playerManaBar').style.width = `${playerManaPercent}%`;
            document.getElementById('playerManaBar').textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            
            // ë¦¬ì»¤ë²„ë¦¬ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const recoveryBtn = document.getElementById('recoveryBtn');
            if (gameState.player.mana >= 20) {
                recoveryBtn.disabled = false;
                recoveryBtn.style.opacity = '1';
            } else {
                recoveryBtn.disabled = true;
                recoveryBtn.style.opacity = '0.6';
            }
            
            // ë¹ŒëŸ° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
            const villainHpPercent = (gameState.villain.hp / gameState.villain.maxHp) * 100;
            document.getElementById('villainHpBar').style.width = `${villainHpPercent}%`;
            document.getElementById('villainHpBar').textContent = `${gameState.villain.hp}/${gameState.villain.maxHp}`;
            document.getElementById('villainAttackBar').textContent = gameState.villain.attack;
            document.getElementById('villainDefenseBar').textContent = gameState.villain.defense;
            
            // ë ˆë²¨ í‘œì‹œ
            document.getElementById('levelIndicator').textContent = `ë ˆë²¨ ${gameState.level}`;

            // âœ¨ [ì¶”ê°€] ë§ˆì™• ì´ë¦„ì— ë ˆë²¨ í‘œì‹œ
            let baseVillainName = defaultConfig.villain_name;
            if (window.elementSdk && window.elementSdk.config && window.elementSdk.config.villain_name) {
                baseVillainName = window.elementSdk.config.villain_name;
            }
            document.getElementById('villainName').textContent = `Lv${gameState.level} ${baseVillainName}`;
        }

        // í›ˆë ¨ì¥ ì—´ê¸°
        function openShop() {
            document.getElementById('shopModal').style.display = 'flex';
            renderShop();
        }

        // í›ˆë ¨ì¥ ë‹«ê¸°
        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
        }

        // ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        function closeShopOnBackdrop(event) {
            if (event.target.id === 'shopModal') {
                closeShop();
            }
        }

        // ìƒì  ë Œë”ë§
        function renderShop() {
            const shopElement = document.getElementById('skillShop');
            shopElement.innerHTML = '';
            
            Object.values(SKILLS).forEach(skill => {
                const owned = gameState.ownedSkills.includes(skill.id);
                const canBuy = gameState.coins >= skill.cost && !owned;
                
                const card = document.createElement('div');
                card.className = 'skill-card';
                
                let useCostText = '';
                if (skill.useCost.type === 'mana') {
                    useCostText = `ë§ˆë‚˜ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'hp') {
                    useCostText = `ì²´ë ¥ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'both') {
                    useCostText = `ì²´ë ¥ ${skill.useCost.hp} / ë§ˆë‚˜ ${skill.useCost.mana}`;
                }
                
                card.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-description">${skill.description}</div>
                    <div class="skill-cost">ğŸ’° ${skill.cost} ì½”ì¸</div>
                    <div class="skill-use-cost">ì‚¬ìš©: ${useCostText}</div>
                    <div class="skill-use-cost">ë°ë¯¸ì§€: ${skill.damage}</div>
                    ${owned ? 
                        '<div class="owned-badge">âœ… ë³´ìœ ì¤‘</div>' :
                        `<button class="buy-skill-btn" onclick="buySkill('${skill.id}')" ${!canBuy ? 'disabled' : ''}>
                            êµ¬ë§¤í•˜ê¸°
                        </button>`
                    }
                `;
                shopElement.appendChild(card);
            });
        }

        // ìŠ¤í‚¬ êµ¬ë§¤
        function buySkill(skillId) {
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            if (gameState.coins < skill.cost) {
                addBattleLog('âŒ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }
            
            if (gameState.ownedSkills.includes(skillId)) {
                addBattleLog('âŒ ì´ë¯¸ ë³´ìœ í•œ ìŠ¤í‚¬ì…ë‹ˆë‹¤!');
                return;
            }
            
            gameState.coins -= skill.cost;
            gameState.ownedSkills.push(skillId);
            
            addBattleLog(`âœ¨ ${skill.name} ìŠ¤í‚¬ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`);
            playupgradeSound();
            
            renderShop();
            renderSkillButtons();
            updateDisplay();
            saveGameProgress();
        }

        // ìŠ¤í‚¬ ë²„íŠ¼ ë Œë”ë§
        function renderSkillButtons() {
            const container = document.getElementById('skillButtonsContainer');
            container.innerHTML = '';
            
            gameState.ownedSkills.forEach(skillId => {
                const skill = SKILLS[skillId];
                if (!skill) return;
                
                const btn = document.createElement('button');
                btn.id = `skill-${skillId}`;
                btn.className = 'skill-use-btn';
                btn.onclick = () => useSkill(skillId);
                
                let costText = '';
                if (skill.useCost.type === 'mana') {
                    costText = `ë§ˆë‚˜ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'hp') {
                    costText = `ì²´ë ¥ ${skill.useCost.amount}`;
                } else if (skill.useCost.type === 'both') {
                    costText = `HP ${skill.useCost.hp} / MP ${skill.useCost.mana}`;
                }
                
                btn.innerHTML = `
                    <span>${skill.icon} ${skill.name}</span>
                    <span class="skill-cost-badge">${costText}</span>
                `;
                
                container.appendChild(btn);
            });
        }

        // ìŠ¤í‚¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSkillButtons() {
            gameState.ownedSkills.forEach(skillId => {
                const btn = document.getElementById(`skill-${skillId}`);
                if (!btn) return;
                
                const skill = SKILLS[skillId];
                let canUse = true;
                
                if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                    canUse = false;
                } else if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                    canUse = false;
                } else if (skill.useCost.type === 'both') {
                    if (gameState.player.hp <= skill.useCost.hp || gameState.player.mana < skill.useCost.mana) {
                        canUse = false;
                    }
                }
                
                btn.disabled = !canUse;
                btn.style.opacity = canUse ? '1' : '0.5';
            });
        }

        // ìŠ¤í‚¬ ì‚¬ìš©
        function useSkill(skillId) {
            if (!gameState.gameActive) return;
            
            const skill = SKILLS[skillId];
            if (!skill) return;
            
            // ë¹„ìš© ì²´í¬
            if (skill.useCost.type === 'mana' && gameState.player.mana < skill.useCost.amount) {
                addBattleLog(`âŒ ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.type === 'hp' && gameState.player.hp <= skill.useCost.amount) {
                addBattleLog(`âŒ ì²´ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${skill.useCost.amount})`);
                return;
            }
            if (skill.useCost.type === 'both') {
                if (gameState.player.hp <= skill.useCost.hp || gameState.player.mana < skill.useCost.mana) {
                    addBattleLog(`âŒ ì²´ë ¥ ë˜ëŠ” ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!`);
                    return;
                }
            }
            
            // ë¹„ìš© ì°¨ê°
            if (skill.useCost.type === 'mana') {
                gameState.player.mana -= skill.useCost.amount;
            } else if (skill.useCost.type === 'hp') {
                gameState.player.hp -= skill.useCost.amount;
            } else if (skill.useCost.type === 'both') {
                gameState.player.hp -= skill.useCost.hp;
                gameState.player.mana -= skill.useCost.mana;
            }
            
            // ë°ë¯¸ì§€ ì ìš© (ê²€ì¦ í¬í•¨)
            let damage = skill.damage;

            // ìŠ¤í‚¬ í”¼í•´ëŸ‰ ì œí•œ í™•ì¸ (ë ˆë²¨ë‹¹ ìµœëŒ€ í”¼í•´ëŸ‰ì˜ 50% ì´ë‚´)
            const maxSkillDamage = Math.floor(gameState.level * GAME_LIMITS.MAX_DAMAGE_PER_LEVEL * 0.5);
            if (damage > maxSkillDamage) {
                damage = maxSkillDamage;
                addBattleLog(`âš ï¸ ìŠ¤í‚¬ í”¼í•´ëŸ‰ì´ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤! (ìµœëŒ€ ${maxSkillDamage})`);
            }

            // ì´ í”¼í•´ëŸ‰ ì œí•œ í™•ì¸
            const newTotalDamage = gameState.currentStats.totalDamage + damage;
            if (newTotalDamage > gameState.level * GAME_LIMITS.MAX_DAMAGE_PER_LEVEL) {
                damage = Math.max(0, (gameState.level * GAME_LIMITS.MAX_DAMAGE_PER_LEVEL) - gameState.currentStats.totalDamage);
                if (damage === 0) {
                    addBattleLog(`âš ï¸ ì¼ì¼ í”¼í•´ëŸ‰ ì œí•œì— ë„ë‹¬í•˜ì—¬ ìŠ¤í‚¬ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                    return;
                }
                addBattleLog(`âš ï¸ ìŠ¤í‚¬ í”¼í•´ëŸ‰ì´ ì¼ì¼ ì œí•œì— ë§ì¶° ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }

            gameState.villain.hp = Math.max(0, gameState.villain.hp - damage);
            gameState.currentStats.totalDamage += damage;
            gameState.currentStats.dailyStats.totalDamage += damage;
            
            addBattleLog(`${skill.icon} ${skill.name} ì‚¬ìš©! ${damage} ë°ë¯¸ì§€!`);

            // ìŠ¤í‚¬ë³„ íš¨ê³¼ìŒ ë° ì´í™íŠ¸
            if (skillId === 'fireball') {
                playFireballSound();
                triggerHitEffect('explosion');
            } else if (skillId === 'fullpower') {
                playfullpowerSound()
                triggerHitEffect('fullpower');  
            } else if (skillId === 'meteor') {
                playmeteoSound();  // ë˜ëŠ” ë©”í…Œì˜¤ ì „ìš© íš¨ê³¼ìŒ
                triggerHitEffect('meteor');  // ë˜ëŠ” ë©”í…Œì˜¤ ì „ìš© ì´í™íŠ¸
            } else if (skillId === 'berserk') {
                playberserkSound();  
                triggerHitEffect('berserk');  
            } else if (skillId === 'ultimate') {
                playultimateSound();  
                triggerHitEffect('ultimate');        
            } else {
                // ê¸°íƒ€ ìŠ¤í‚¬ (ultimate)
                playHeroAttackSound();
                triggerHitEffect('heroattack');
            }
            
            if (gameState.villain.hp <= 0) {
                victory();
                return;
            }
            
            updateDisplay();
            saveGameProgress();
        }    


        // ì „íˆ¬ ë¡œê·¸ ì¶”ê°€
        function addBattleLog(message) {
            const log = document.getElementById('battleLog');
            log.innerHTML = message + '<br>' + log.innerHTML;  // ğŸ‘ˆ ì•ì— ì¶”ê°€
            
        }

        // ìŠ¹ë¦¬
        function victory() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            // ë¬¸ì œ í’€ì´ ë¹„í™œì„±í™”
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('answerInput').style.opacity = '0.6';
            document.getElementById('submitBtn').style.opacity = '0.6';
            
            // ê¸°ë¡ ì—…ë°ì´íŠ¸ ë° ì €ì¥
            updateBestRecords();
            saveGameSession();
            saveGameProgress();
            
            // ëª¨ë‹¬ë¡œ ë³€ê²½
            document.getElementById('victoryModal').style.display = 'flex';
            addBattleLog(`ğŸ‰ ë ˆë²¨ ${gameState.level} í´ë¦¬ì–´! ğŸ‰`);
            addBattleLog('ë‹¤ìŒ ë ˆë²¨ë¡œ ì§„í–‰í•˜ì„¸ìš”!');
        }

        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            gameState.gameActive = false;
            clearInterval(gameState.battleInterval);
            
            // ê¸°ë¡ ì €ì¥
            updateBestRecords();
            saveGameSession();
            saveBestRecords(); // ì¶”ê°€

            // ì§„í–‰ ìƒí™© ì‚­ì œ
            localStorageHelper.remove('gameProgress');
            
            // ëª¨ë‹¬ë¡œ ë³€ê²½
            document.getElementById('gameOverModal').style.display = 'flex';
            addBattleLog('ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ğŸ’€');
            playgameoverSound();
        }

        // ë‹¤ìŒ ë ˆë²¨
        function nextLevel() {
            // ìµœëŒ€ ë ˆë²¨ ì œí•œ í™•ì¸
            if (gameState.level >= GAME_LIMITS.MAX_LEVEL) {
                addBattleLog(`ğŸ‰ ìµœëŒ€ ë ˆë²¨(${GAME_LIMITS.MAX_LEVEL})ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤! ê²Œì„ í´ë¦¬ì–´!`);
                victory(); // ìŠ¹ë¦¬ ì²˜ë¦¬
                return;
            }

            gameState.level++;
            gameState.gameActive = true;
            
            // ë¹ŒëŸ° ê°•í™”
            const levelMultiplier = 1 + (gameState.level - 1) * 0.3;
            gameState.villain = {
                hp: Math.floor(80 * levelMultiplier),
                maxHp: Math.floor(80 * levelMultiplier),
                attack: Math.floor(12 * levelMultiplier),
                defense: Math.floor(8 * levelMultiplier)
            };

            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('victoryModal').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';
    
                        
            // ë¬¸ì œ í’€ì´ ì¬í™œì„±í™”
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            addBattleLog(`ë ˆë²¨ ${gameState.level} ì‹œì‘! ë” ê°•í•œ ${document.getElementById('villainName').textContent}ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
            
            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // ê²Œì„ ì¬ì‹œì‘ (ê²€ì¦ ê°•í™”)
        function restartGame() {
            // ìµœê³  ê¸°ë¡ ê²€ì¦ (ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ê¸°ë¡ì´ ìˆì–´ë„ ì´ˆê¸°í™”í•˜ì§€ ì•Šê³  ìœ ì§€)
            // ëŒ€ì‹  ë­í‚¹ ì—…ë¡œë“œ ì‹œì— í•„í„°ë§ë¨
            if (dataValidator.detectSuspiciousPatterns(gameState.bestRecords)) {
                console.warn('ê²Œì„ ì¬ì‹œì‘: ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ìµœê³  ê¸°ë¡ ê°ì§€ë¨ (ì‚­ì œí•˜ì§€ ì•ŠìŒ)');
            }

            gameState = {
                level: 1,
                coins: 0, 
                ownedSkills: [], 
                player: { hp: 100, maxHp: 100, attack: 15, defense: 10, mana: 0, maxMana: 20 },
                villain: { hp: 80, maxHp: 80, attack: 12, defense: 8 },
                currentProblem: { num1: 0.5, num2: 2, answer: 1.0 },
                battleInterval: null,
                manaInterval: null,
                gameActive: true,
                
                // ì‹œê°„ ê´€ë ¨ ì´ˆê¸°í™”
                lastActionTime: Date.now(),
                lastProblemSolvedTime: 0,

                // í˜„ì¬ í”Œë ˆì´ ê¸°ë¡ ì´ˆê¸°í™”
                currentStats: {
                    problemsSolved: 0,
                    totalDamage: 0,
                    startTime: Date.now(),
                    dailyStats: {
                        date: new Date().toDateString(),
                        problemsSolved: 0,
                        totalDamage: 0,
                        playTime: 0
                    }
                },
                // ìµœê³  ê¸°ë¡ì€ ìœ ì§€
                bestRecords: gameState.bestRecords
            };
            
            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('upgradeSection').style.display = 'none';

            
            // ë¬¸ì œ í’€ì´ ì¬í™œì„±í™”
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').disabled = false;
            document.getElementById('answerInput').style.opacity = '1';
            document.getElementById('submitBtn').style.opacity = '1';
            
            document.getElementById('battleLog').innerHTML = 'ê²Œì„ì´ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!<br>';
            
            renderSkillButtons(); // ì¶”ê°€

            updateDisplay();
            saveGameProgress();
            generateProblem();
            startBattle();
            startManaRegeneration();
        }

        // ğŸ‘‡ ì—¬ê¸°ë¶€í„° ì¶”ê°€

        // ========== ë­í‚¹ ì‹œìŠ¤í…œ ==========

        let currentRankingTab = 'level';

        // ì‚¬ìš©ì ì´ë¦„ ë¡œë“œ
        function loadUsername() {
            const savedUsername = localStorageHelper.load('username');
            if (savedUsername) {
                gameState.username = savedUsername;
                document.getElementById('currentUsername').textContent = `í˜„ì¬ ì´ë¦„: ${savedUsername}`;
                document.getElementById('usernameInput').value = savedUsername;
            }
        }

        // ì‚¬ìš©ì ì´ë¦„ ì €ì¥ (ìˆ˜ì •)
        async function saveUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!username) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (username.length > 10) {
                alert('ì´ë¦„ì€ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            gameState.username = username;
            localStorageHelper.save('username', username);
            document.getElementById('currentUsername').textContent = `í˜„ì¬ ì´ë¦„: ${username}`;
            
            // ë­í‚¹ ì—…ë°ì´íŠ¸ (async)
            await uploadToRanking();
            alert('ì´ë¦„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ë­í‚¹ ë‹¤ì‹œ ë Œë”ë§
            await renderRanking();
        }

        // ë­í‚¹ì— ë‚´ ê¸°ë¡ ì—…ë¡œë“œ (ê²€ì¦ ê°•í™” ë²„ì „)
        async function uploadToRanking() {
            if (!gameState.username || gameState.username === 'ìµëª…') {
                console.log('ìµëª… ì‚¬ìš©ìëŠ” ë­í‚¹ì— ì—…ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const myRecord = {
                username: gameState.username,
                level: gameState.bestRecords.level || 0,
                problems: gameState.bestRecords.problemsSolved || 0,
                damage: gameState.bestRecords.totalDamage || 0,
                timestamp: new Date().toISOString(),
                client_validation: true // í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ ì™„ë£Œ í‘œì‹œ
            };

            // ğŸ”’ ì „ì ì„œëª… ìƒì„±
            myRecord.signature = createSignature(myRecord.username, myRecord.level, myRecord.problems, myRecord.damage);

            // ê¸°ë¡ ê²€ì¦ (ë‹¨ìˆœ ìƒí•œì„  ì²´í¬ ì™„í™”)
            if (!dataValidator.validateLevel(myRecord.level)) {
                 // ë ˆë²¨ì´ ë„ˆë¬´ ë†’ìœ¼ë©´ ì—…ë¡œë“œë§Œ ì°¨ë‹¨
                console.warn('ë­í‚¹ ì—…ë¡œë“œ: ë ˆë²¨ ê²€ì¦ ì‹¤íŒ¨');
                return;
            }

            // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ ê²€ì¶œ (ì—„ê²©í•˜ê²Œ ì²´í¬)
            if (dataValidator.detectSuspiciousPatterns({
                level: myRecord.level,
                problemsSolved: myRecord.problems,
                totalDamage: myRecord.damage
            })) {
                console.warn('ë­í‚¹ ì—…ë¡œë“œ: ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ ê°ì§€ë¨ (ì—…ë¡œë“œ ì œí•œ)');
                addBattleLog('âš ï¸ ë­í‚¹ ì—…ë¡œë“œ ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ì•Šì•„ ìˆœìœ„ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ë¡ì´ í•˜ë‚˜ë¼ë„ 0ë³´ë‹¤ í¬ë©´ ì—…ë¡œë“œ
            if (myRecord.level === 0 && myRecord.problems === 0 && myRecord.damage === 0) {
                console.log('ì—…ë¡œë“œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', // CORS ë¬¸ì œ íšŒí”¼
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(myRecord)
                });

                console.log('ë­í‚¹ ì—…ë¡œë“œ ì™„ë£Œ');
                addBattleLog('ğŸ† ë­í‚¹ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ë­í‚¹ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                addBattleLog('âš ï¸ ë­í‚¹ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë­í‚¹ ëª¨ë‹¬ ì—´ê¸° (ìˆ˜ì •)
        async function openRanking() {
            loadUsername();
            await uploadToRanking(); // await ì¶”ê°€
            document.getElementById('rankingModal').style.display = 'flex';
            await renderRanking(); // await ì¶”ê°€
        }

        // ë­í‚¹ ëª¨ë‹¬ ë‹«ê¸°
        function closeRanking() {
            document.getElementById('rankingModal').style.display = 'none';
        }

        // ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€
        // ========== ì¹˜íŠ¸ ì‹œìŠ¤í…œ ==========

        // ì¹˜íŠ¸ ëª¨ë‹¬ ì—´ê¸°
        function openCheat() {
            document.getElementById('cheatModal').style.display = 'flex';
            document.getElementById('cheatInput').value = '';
        }

        // ì¹˜íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeCheat() {
            document.getElementById('cheatModal').style.display = 'none';
        }

        // ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        function closeCheatOnBackdrop(event) {
            if (event.target.id === 'cheatModal') {
                closeCheat();
            }
        }

        // ì¹˜íŠ¸ í™œì„±í™”
        function activateCheat() {
            const password = document.getElementById('cheatInput').value;
            
            if (password === '1050') {
                // ì¹˜íŠ¸ ì‚¬ìš© ì œí•œ: ì´ë¯¸ ì½”ì¸ì´ ë§ê±°ë‚˜ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´ì´ ìˆìœ¼ë©´ ê±°ë¶€
                if (gameState.coins > 1000) {
                    alert('âŒ ì´ë¯¸ ì¶©ë¶„í•œ ì½”ì¸ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!');
                    document.getElementById('cheatInput').value = '';
                    return;
                }

                // ì¼ì¼ í†µê³„ í™•ì¸
                dataValidator.resetDailyStatsIfNeeded();
                if (gameState.currentStats.dailyStats.problemsSolved > GAME_LIMITS.MAX_PROBLEMS_PER_DAY / 2) {
                    alert('âŒ ì˜¤ëŠ˜ ì´ë¯¸ ë§ì€ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤!');
                    document.getElementById('cheatInput').value = '';
                    return;
                }

                gameState.coins += 1000; // ì½”ì¸ ì–‘ë„ ì¤„ì„
                updateDisplay();
                saveGameProgress();
                addBattleLog('ğŸ® ê°œë°œì ì§€ì›: 1,000 ì½”ì¸ì„ ì–»ì—ˆìŠµë‹ˆë‹¤!');
                playupgradeSound();
                alert('ê°œë°œì ì§€ì›: 1,000 ì½”ì¸ì„ ì–»ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                closeCheat();
            } else {
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
                document.getElementById('cheatInput').value = '';
            }
        }



        // ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        function closeRankingOnBackdrop(event) {
            if (event.target.id === 'rankingModal') {
                closeRanking();
            }
        }

        // ë­í‚¹ íƒ­ ì „í™˜ (ìˆ˜ì •)
        async function switchRankingTab(tab) {
            currentRankingTab = tab;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.ranking-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            await renderRanking(); // await ì¶”ê°€
        }

        // ë­í‚¹ ë Œë”ë§ (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë²„ì „)
        async function renderRanking() {
            const tbody = document.getElementById('rankingTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="no-data">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
            
            // ë‚´ ìˆœìœ„ ë°•ìŠ¤ ì¼ë‹¨ ìˆ¨ê¸°ê¸°
            const myRankBox = document.getElementById('myRankBox');
            myRankBox.style.display = 'none';    

            try {
                // [ìˆ˜ì • 1] URLì— username íŒŒë¼ë¯¸í„° ì¶”ê°€!
                const url = `${SPREADSHEET_URL}?type=${currentRankingTab}&username=${encodeURIComponent(gameState.username)}`;
                console.log('ğŸ” ìš”ì²­ URL:', url);
                
                const response = await fetch(url);
                const data = await response.json(); // response.text() í›„ parsing í•˜ëŠ” ê³¼ì •ì„ ê°„ì†Œí™”
                
                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="no-data">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                let label = '';
                switch(currentRankingTab) {
                    case 'level': label = 'ë ˆë²¨'; break;
                    case 'problems': label = 'ë¬¸ì œ ìˆ˜'; break;
                    case 'damage': label = 'í”¼í•´ëŸ‰'; break;
                }

                // ğŸ‘‡ ë‚´ ìˆœìœ„ ì°¾ê¸°
                let myRank = -1;
                let myValue = 0;

                // ë°ì´í„° ì „ì²´ë¥¼ ìˆœíšŒí•˜ë©° ë‚˜ë¥¼ ì°¾ìŒ
                data.forEach((record, index) => {
                    if (record.username === gameState.username) {
                        // [ìˆ˜ì • 2] ë°±ì—”ë“œì—ì„œ rankë¥¼ ì¤¬ìœ¼ë©´(100ìœ„ ë°–) ê·¸ê±° ì“°ê³ , ì•„ë‹ˆë©´ index + 1
                        if (record.rank) {
                            myRank = record.rank;
                        } else {
                            myRank = index + 1;
                        }

                        switch(currentRankingTab) {
                            case 'level': myValue = record.level; break;
                            case 'problems': myValue = record.problems; break;
                            case 'damage': myValue = record.damage; break;
                        }
                    }
                });

                // ğŸ‘‡ ë‚´ ìˆœìœ„ê°€ 100ìœ„ ë°–ì´ë©´ ìƒë‹¨ ë°•ìŠ¤ì— í‘œì‹œ (ìˆœìœ„ê°€ í™•ì¸ë˜ì—ˆì„ ë•Œë§Œ)
                if (myRank > 100) {
                    myRankBox.style.display = 'block';
                    document.getElementById('myRankNumber').textContent = `${myRank}ìœ„`;
                    document.getElementById('myRankValue').textContent = `${myValue} ${label}`;
                } else if (myRank !== -1) {
                    // 100ìœ„ ì•ˆì´ë¼ë©´ ìƒë‹¨ ë°•ìŠ¤ëŠ” ìˆ¨ê¸°ê³  í…Œì´ë¸”ì—ì„œ ê°•ì¡°ë¨
                    myRankBox.style.display = 'none';
                } else {
                    // ë­í‚¹ì— ì—†ëŠ” ê²½ìš° (ìƒˆë¡œ ì‹œì‘í•œ ê²½ìš° ë“±)
                    myRankBox.style.display = 'none';
                }
                
                
                tbody.innerHTML = '';
                
                // í…Œì´ë¸”ì—ëŠ” ë¬´ì¡°ê±´ ìƒìœ„ 100ëª…ë§Œ í‘œì‹œ
                const displayData = data.slice(0, 100);
                
                displayData.forEach((record, index) => {
                    const rank = index + 1;
                    let medal = '';
                    
                    if (rank === 1) medal = 'ğŸ¥‡';
                    else if (rank === 2) medal = 'ğŸ¥ˆ';
                    else if (rank === 3) medal = 'ğŸ¥‰';
                    
                    const isMyRecord = record.username === gameState.username;
                    
                    let value;
                    switch(currentRankingTab) {
                        case 'level': value = record.level; break;
                        case 'problems': value = record.problems; break;
                        case 'damage': value = record.damage; break;
                    }
                    
                    const row = document.createElement('tr');
                    // 100ìœ„ ì•ˆì¼ ê²½ìš° ë‚´ ì¤„ ê°•ì¡°
                    if (isMyRecord) row.classList.add('my-rank');
                    
                    row.innerHTML = `
                        <td><span class="rank-medal">${medal}</span>${rank}ìœ„</td>
                        <td>${record.username}${isMyRecord ? ' (ë‚˜)' : ''}</td>
                        <td>${value} ${label}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // [ì„ íƒ ì‚¬í•­] 100ìœ„ ë°–ì¼ ë•Œ í…Œì´ë¸” ë§¨ ì•„ë˜ì—ë„ ì ì„ ê³¼ í•¨ê»˜ í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ ìœ ì§€
                // ìƒë‹¨ ë°•ìŠ¤(myRankBox)ë§Œ ì“¸ ê±°ë©´ ì´ ë¶€ë¶„ì€ ì§€ì›Œë„ ë©ë‹ˆë‹¤.
                if (myRank > 100) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = '<td colspan="3" style="text-align: center; padding: 10px; background: #e2e8f0; font-weight: bold;">â‹¯</td>';
                    tbody.appendChild(separatorRow);

                    const myRow = document.createElement('tr');
                    myRow.classList.add('my-rank');
                    myRow.innerHTML = `
                        <td><span class="rank-medal"></span>${myRank}ìœ„</td>
                        <td>${gameState.username} (ë‚˜)</td>
                        <td>${myValue} ${label}</td>
                    `;
                    tbody.appendChild(myRow);
                }
                
                console.log('âœ¨ ë Œë”ë§ ì™„ë£Œ!');
            } catch (error) {
                console.error('ğŸ’¥ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                tbody.innerHTML = '<tr><td colspan="3" class="no-data">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // ê²Œì„ ì´ˆê¸°í™”
        generateProblem();
        updateDisplay();
        updateRecordsDisplay();
        renderSkillButtons(); // ì´ ì¤„ ì¶”ê°€

        
        // ë°ì´í„°ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ê²Œì„ ì‹œì‘
        setTimeout(() => {
            if (!gameLoaded) {
                // ì €ì¥ëœ ê²Œì„ì´ ì—†ìœ¼ë©´ ìƒˆ ê²Œì„ ì‹œì‘
                startBattle();
                startManaRegeneration();
            } else {
                // ì €ì¥ëœ ê²Œì„ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‹œì‘
                startBattle();
                startManaRegeneration();
            }
        }, 500);
        
        // ê¸°ë¡ í‘œì‹œ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
        setInterval(updateRecordsDisplay, 1000);
        function playHeroAttackSound() {
        const audio = document.getElementById('hero-hit');
        audio.currentTime = 0;
        audio.play();
      }
      //ì‚¬ìš´ë“œ
        function playBossAttackSound() {
            const audio = document.getElementById('boss-hit');
            audio.currentTime = 0;
            audio.play();
        }

        function playupgradeSound() {
            const audio = document.getElementById('upgrade-sound');
            audio.currentTime = 0;
            audio.play();
        }
        function playhealingSound() {
        const audio = document.getElementById('healing-magic');
        audio.currentTime = 0;
        audio.play();
      }
        function playgameoverSound() {
        const audio = document.getElementById('game-over');
        audio.currentTime = 0;
        audio.play();
      }

        function playmeteoSound() {
        const audio = document.getElementById('meteo-sound');
        audio.currentTime = 0;
        audio.play();
      }

        function playberserkSound() {
        const audio = document.getElementById('berserk-sound');
        audio.currentTime = 0;
        audio.play();
      }
        function playultimateSound() {
        const audio = document.getElementById('ultimate-sound');
        audio.currentTime = 0;
        audio.play();
      }




      // ğŸ‘‡ ì—¬ê¸°ì— ì¶”ê°€
        function playFireballSound() {
            const audio = document.getElementById('fireball-sound');
            audio.currentTime = 0;
            audio.play();
      }

        function playfullpowerSound() {
        const audio = document.getElementById('fullpower-sound');
        audio.currentTime = 0;
        audio.play();
      }

      function playfirebreakSound() {
            const audio = document.getElementById('fire-break-sound');
            audio.currentTime = 0;
            audio.play();
        }




        // íƒ€ê²© íš¨ê³¼ë¥¼ ì¶œë ¥í•˜ê³  ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        function triggerHitEffect(targetId) {
            const effectElement = document.getElementById(targetId);

            // âœ¨ [ì•ˆì „ ì¥ì¹˜ ì¶”ê°€] ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í•˜ë©´(null) ì˜¤ë¥˜ ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!effectElement) { 
            console.error(`íƒ€ê²© íš¨ê³¼ ìš”ì†Œ(ID: ${targetId})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ íš¨ê³¼ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
    }
            
            // 1. íš¨ê³¼ ì¶œë ¥ (display: blockìœ¼ë¡œ ë³€ê²½)
            effectElement.style.display = 'block';
            
            // 2. ì ì‹œ í›„ íš¨ê³¼ ìˆ¨ê¹€ (300ms = 0.3ì´ˆ)
            setTimeout(() => {
                effectElement.style.display = 'none';
            }, 300); 
        }
    </script>
</html>